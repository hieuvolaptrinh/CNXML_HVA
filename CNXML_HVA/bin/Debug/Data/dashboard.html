<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Football Field Management</title>

    <!-- Fonts (modern) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/dashboard.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/app.js"></script>
    <script src="js/crud.js"></script>
    <script src="js/components.js"></script>
  </head>

  <body class="dashboard-page">
    <!-- Sidebar -->
    <div id="sidebar"></div>

    <!-- Main Content -->
    <main class="dashboard-main">
      <!-- Hero -->
      <section class="hero">
        <div class="hero-content">
          <div class="hero-badge">
            <i class="fas fa-wave-square"></i>
            <span>Live Analytics</span>
          </div>

          <h1 class="hero-title">
            <i class="fas fa-chart-line"></i>
            Dashboard Overview
          </h1>
          <p class="hero-subtitle">
            Real-time statistics and analytics for football field management
          </p>
        </div>

        <div class="hero-icon">
          <i class="fas fa-futbol"></i>
        </div>
      </section>

      <!-- Stats -->
      <section class="section">
        <div class="stats-grid" id="statsCards"></div>
      </section>

      <!-- Revenue Trend -->
      <section class="section">
        <div class="card-modern">
          <div class="card-head">
            <h3>
              <i class="fas fa-chart-area"></i>
              Revenue Trend (Last 6 Months)
            </h3>
            <span class="pill">Line / Dual axis</span>
          </div>

          <div class="card-body">
            <div class="chart-wrap chart-lg">
              <canvas id="revenueTrendChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- 
      <section class="section grid-12">
        <div class="card-modern col-6">
          <div class="card-head">
            <h3><i class="fas fa-chart-pie"></i> Booking Status</h3>
            <span class="pill">Pie</span>
          </div>
          <div class="card-body">
            <div class="chart-wrap chart-md">
              <canvas id="bookingStatusChart"></canvas>
            </div>
          </div>
        </div> -->

        <div class="card-modern col-6">
          <div class="card-head">
            <h3><i class="fas fa-circle-notch"></i> Field Utilization</h3>
            <span class="pill">Doughnut</span>
          </div>
          <div class="card-body">
            <div class="chart-wrap chart-md">
              <canvas id="fieldUtilizationChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Small charts -->
      <section class="section grid-12">
        <div class="card-modern col-4">
          <div class="card-head">
            <h3><i class="fas fa-users"></i> Customers</h3>
            <span class="pill">Bar</span>
          </div>
          <div class="card-body">
            <div class="chart-wrap chart-sm">
              <canvas id="customerChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card-modern col-4">
          <div class="card-head">
            <h3><i class="fas fa-tools"></i> Equipment</h3>
            <span class="pill">Doughnut</span>
          </div>
          <div class="card-body">
            <div class="chart-wrap chart-sm">
              <canvas id="equipmentChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card-modern col-4">
          <div class="card-head">
            <h3><i class="fas fa-building"></i> Branches</h3>
            <span class="pill">Bar</span>
          </div>
          <div class="card-body">
            <div class="chart-wrap chart-sm">
              <canvas id="branchChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Lists -->
      <section class="section grid-12">
        <div class="card-modern col-6">
          <div class="card-head">
            <h3><i class="fas fa-calendar-check"></i> Recent Bookings</h3>
            <span class="pill">Latest 5</span>
          </div>
          <div class="card-body">
            <div id="recentBookings" class="list"></div>
          </div>
        </div>

        <div class="card-modern col-6">
          <div class="card-head">
            <h3><i class="fas fa-star"></i> Top Customers</h3>
            <span class="pill">Top 5</span>
          </div>
          <div class="card-body">
            <div id="topCustomers" class="list"></div>
          </div>
        </div>
      </section>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        requireAuth();
        document.getElementById("sidebar").innerHTML =
          createSidebar("dashboard");

        // ===== Global Chart defaults (fix "chart quá to" + đẹp hơn) =====
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.color = "rgba(229,231,235,.75)";
        Chart.defaults.font.family =
          "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.legend.labels.boxWidth = 10;
        Chart.defaults.plugins.legend.labels.padding = 14;

        await Promise.all([
          loadStatsCards(),
          loadRevenueTrend(),
          loadBookingStatus(),
          loadFieldUtilization(),
          loadCustomerChart(),
          loadEquipmentChart(),
          loadBranchChart(),
          loadRecentBookings(),
          loadTopCustomers(),
        ]);
      });

      async function loadStatsCards() {
        try {
          const [branches, fields, bookings, customers] = await Promise.all([
            crudManager.getMergedData("Branches.xml", "branch"),
            crudManager.getMergedData("Fields.xml", "field"),
            crudManager.getMergedData("Bookings.xml", "booking"),
            crudManager.getMergedData("Customers.xml", "customer"),
          ]);

          const stats = [
            {
              icon: "building",
              label: "Chi nhánh",
              value: branches.length,
              bg: "linear-gradient(135deg, rgba(76,175,80,.95), rgba(102,187,106,.75))",
            },
            {
              icon: "map-marked-alt",
              label: "Sân bóng",
              value: fields.length,
              bg: "linear-gradient(135deg, rgba(33,150,243,.95), rgba(66,165,245,.75))",
            },
            {
              icon: "calendar-check",
              label: "Đặt lịch",
              value: bookings.length,
              bg: "linear-gradient(135deg, rgba(255,152,0,.95), rgba(255,167,38,.75))",
            },
            {
              icon: "users",
              label: "Khách hàng",
              value: customers.length,
              bg: "linear-gradient(135deg, rgba(156,39,176,.95), rgba(171,71,188,.75))",
            },
          ];

          const statsHTML = stats
            .map(
              (s) => `
              <div class="stat-card" style="background:${s.bg}">
                <div class="stat-top">
                  <div class="stat-label">${s.label}</div>
                  <div class="stat-chip">
                    <i class="fas fa-${s.icon}"></i>
                  </div>
                </div>
                <div class="stat-value" data-value="${s.value}">0</div>
                <div class="stat-hint">Updated just now</div>
              </div>
            `
            )
            .join("");

          document.getElementById("statsCards").innerHTML = statsHTML;

          document.querySelectorAll(".stat-value").forEach((el) => {
            const value = parseInt(el.dataset.value);
            animateValue(el, 0, value, 1200);
          });
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      async function loadRevenueTrend() {
        try {
          const [bookings, fields] = await Promise.all([
            crudManager.getMergedData("Bookings.xml", "booking"),
            crudManager.getMergedData("Fields.xml", "field"),
          ]);

          // Tạo map field để lấy giá
          const fieldMap = {};
          fields.forEach((f) => {
            fieldMap[f.name] = parseInt(f.price_per_hour || 0);
            fieldMap[f.id] = parseInt(f.price_per_hour || 0);
          });

          // Tính doanh thu và số booking theo tháng từ Bookings.xml
          const monthlyData = {};
          const monthNames = [
            "Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6",
            "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"
          ];

          // Xử lý bookings
          bookings.forEach((b) => {
            const date = b.date || b.booking_date;
            if (date) {
              const month = new Date(date).getMonth();
              const year = new Date(date).getFullYear();
              const key = `${year}-${month}`;
              if (!monthlyData[key]) {
                monthlyData[key] = { revenue: 0, count: 0, month, year };
              }
              const fieldPrice = fieldMap[b.field] || 150000;
              const duration = parseInt(b.duration || 1);
              monthlyData[key].revenue += fieldPrice * duration;
              monthlyData[key].count += 1;
            }
          });

          // Sắp xếp và lấy 6 tháng gần nhất có dữ liệu
          const sortedKeys = Object.keys(monthlyData).sort();
          const recentKeys = sortedKeys.slice(-6);

          const months = recentKeys.map((k) => monthNames[monthlyData[k].month]);
          const revenue = recentKeys.map((k) => monthlyData[k].revenue);
          const bookingCounts = recentKeys.map((k) => monthlyData[k].count);

          // Nếu không có dữ liệu, hiển thị mặc định
          const displayMonths = months.length > 0 ? months : ["Không có dữ liệu"];
          const displayRevenue = revenue.length > 0 ? revenue : [0];
          const displayBookings = bookingCounts.length > 0 ? bookingCounts : [0];

          const ctx = document
            .getElementById("revenueTrendChart")
            .getContext("2d");

          new Chart(ctx, {
            type: "line",
            data: {
              labels: displayMonths,
              datasets: [
                {
                  label: "Doanh thu (VNĐ)",
                  data: displayRevenue,
                  borderColor: "rgba(76,175,80,1)",
                  backgroundColor: "rgba(76,175,80,.10)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 3,
                  pointHoverRadius: 5,
                  yAxisID: "y",
                },
                {
                  label: "Số lượng booking",
                  data: displayBookings,
                  borderColor: "rgba(33,150,243,1)",
                  backgroundColor: "rgba(33,150,243,.10)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 3,
                  pointHoverRadius: 5,
                  yAxisID: "y1",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: "index", intersect: false },
              plugins: {
                legend: { display: true, position: "top" },
                tooltip: {
                  padding: 12,
                  callbacks: {
                    label: function (context) {
                      let label = context.dataset.label || "";
                      if (context.parsed.y !== null) {
                        if (context.datasetIndex === 0) {
                          label += ": " + formatCurrency(context.parsed.y);
                        } else {
                          label += ": " + context.parsed.y + " bookings";
                        }
                      }
                      return label;
                    },
                  },
                },
              },
              scales: {
                x: {
                  grid: { color: "rgba(255,255,255,.06)" },
                  ticks: { color: "rgba(229,231,235,.75)" },
                },
                y: {
                  type: "linear",
                  display: true,
                  position: "left",
                  grid: { color: "rgba(255,255,255,.06)" },
                  ticks: {
                    callback: (value) => value / 1000000 + "M",
                    color: "rgba(229,231,235,.75)",
                  },
                },
                y1: {
                  type: "linear",
                  display: true,
                  position: "right",
                  grid: { drawOnChartArea: false },
                  ticks: { color: "rgba(229,231,235,.75)" },
                },
              },
            },
          });
        } catch (error) {
          console.error("Error loading revenue trend:", error);
        }
      }

      async function loadBookingStatus() {
        try {
          const bookings = await crudManager.getMergedData(
            "Bookings.xml",
            "booking"
          );

          const statusCounts = {
            Confirmed: 0,
            Pending: 0,
            Cancelled: 0,
            Completed: 0,
          };
          bookings.forEach((b) => {
            const status = b.status || "Pending";
            if (statusCounts[status] !== undefined) statusCounts[status]++;
          });

          const ctx = document
            .getElementById("bookingStatusChart")
            .getContext("2d");

          new Chart(ctx, {
            type: "pie",
            data: {
              labels: Object.keys(statusCounts),
              datasets: [
                {
                  data: Object.values(statusCounts),
                  backgroundColor: ["#4caf50", "#ff9800", "#f44336", "#2196f3"],
                  borderWidth: 2,
                  borderColor: "rgba(255,255,255,.9)",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: "bottom" },
                tooltip: { padding: 12 },
              },
            },
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadFieldUtilization() {
        try {
          const fields = await crudManager.getMergedData("Fields.xml", "field");
          const statusCounts = {};
          const statusColors = { Available: "#4caf50", Booked: "#ff9800", Maintenance: "#9e9e9e" };

          fields.forEach((f) => {
            const status = f.status || "Available";
            statusCounts[status] = (statusCounts[status] || 0) + 1;
          });

          // Chỉ lấy các status có dữ liệu > 0
          const labels = Object.keys(statusCounts).filter(k => statusCounts[k] > 0);
          const data = labels.map(k => statusCounts[k]);
          const colors = labels.map(k => statusColors[k] || "#9e9e9e");

          const ctx = document
            .getElementById("fieldUtilizationChart")
            .getContext("2d");

          new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: labels,
              datasets: [
                {
                  data: data,
                  backgroundColor: colors,
                  borderWidth: 2,
                  borderColor: "rgba(255,255,255,.9)",
                  hoverOffset: 8,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "62%",
              plugins: {
                legend: { position: "bottom" },
                tooltip: { padding: 12 },
              },
            },
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadCustomerChart() {
        try {
          const customers = await crudManager.getMergedData(
            "Customers.xml",
            "customer"
          );
          const membershipCounts = {};
          const membershipColors = { VIP: "#ffd700", Gold: "#c0c0c0", Silver: "#cd7f32", None: "#9e9e9e" };

          customers.forEach((c) => {
            const m = c.membership || "None";
            membershipCounts[m] = (membershipCounts[m] || 0) + 1;
          });

          // Chỉ lấy các membership có dữ liệu > 0
          const labels = Object.keys(membershipCounts).filter(k => membershipCounts[k] > 0);
          const data = labels.map(k => membershipCounts[k]);
          const colors = labels.map(k => membershipColors[k] || "#9e9e9e");

          const ctx = document.getElementById("customerChart").getContext("2d");

          new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Customers",
                  data: data,
                  backgroundColor: colors,
                  borderWidth: 0,
                  borderRadius: 10,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: { color: "rgba(229,231,235,.75)" },
                },
                y: {
                  beginAtZero: true,
                  grid: { color: "rgba(255,255,255,.06)" },
                  ticks: { color: "rgba(229,231,235,.75)" },
                },
              },
            },
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadEquipmentChart() {
        try {
          const equipments = await crudManager.getMergedData(
            "Equipments.xml",
            "equipment"
          );

          // Đếm theo category (loại thiết bị) và số lượng
          const categoryCounts = {};
          const categoryColors = [
            "#4caf50", "#2196f3", "#ff9800", "#9c27b0", "#f44336", 
            "#00bcd4", "#8bc34a", "#ff5722", "#673ab7", "#009688"
          ];

          equipments.forEach((eq) => {
            const category = eq.category || "Khác";
            const quantity = parseInt(eq.quantity_total || 0);
            categoryCounts[category] = (categoryCounts[category] || 0) + quantity;
          });

          // Chỉ lấy các category có số lượng > 0
          const labels = Object.keys(categoryCounts).filter(k => categoryCounts[k] > 0);
          const data = labels.map(k => categoryCounts[k]);
          const colors = labels.map((k, i) => categoryColors[i % categoryColors.length]);

          const ctx = document
            .getElementById("equipmentChart")
            .getContext("2d");

          new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: labels,
              datasets: [
                {
                  data: data,
                  backgroundColor: colors,
                  borderWidth: 2,
                  borderColor: "rgba(255,255,255,.9)",
                  hoverOffset: 8,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "62%",
              plugins: { legend: { position: "bottom" } },
            },
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadBranchChart() {
        try {
          const branches = await crudManager.getMergedData(
            "Branches.xml",
            "branch"
          );
          const names = branches.map((b) => b.name || b.code);
          const revenues = branches.map((b) =>
            parseInt(b.monthly_revenue || 0)
          );

          const ctx = document.getElementById("branchChart").getContext("2d");

          new Chart(ctx, {
            type: "bar",
            data: {
              labels: names,
              datasets: [
                {
                  label: "Revenue",
                  data: revenues,
                  backgroundColor: "rgba(76,175,80,.95)",
                  borderWidth: 0,
                  borderRadius: 10,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: { color: "rgba(229,231,235,.75)" },
                },
                y: {
                  beginAtZero: true,
                  grid: { color: "rgba(255,255,255,.06)" },
                  ticks: {
                    callback: (value) => value / 1000000 + "M",
                    color: "rgba(229,231,235,.75)",
                  },
                },
              },
            },
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadRecentBookings() {
        try {
          const bookings = await crudManager.getMergedData(
            "Bookings.xml",
            "booking"
          );
          const recent = bookings.slice(-5).reverse();

          const html = recent
            .map((b) => {
              const name = b.customer_name || b.customer || "N/A";
              const date = b.booking_date || b.date || "N/A";
              const time = b.booking_time || b.time || "N/A";
              const status = b.status || "Pending";
              const badgeClass =
                status === "Confirmed"
                  ? "badge-success"
                  : status === "Cancelled"
                  ? "badge-danger"
                  : status === "Completed"
                  ? "badge-info"
                  : "badge-warning";

              return `
                <div class="list-item">
                  <div class="list-left">
                    <div class="list-title">${name}</div>
                    <div class="list-sub">${date} • ${time}h</div>
                  </div>
                  <span class="badge ${badgeClass}">${status}</span>
                </div>
              `;
            })
            .join("");

          document.getElementById("recentBookings").innerHTML =
            html ||
            `<div class="empty-state">
              <i class="fas fa-inbox"></i>
              <div>Chưa có đặt lịch nào</div>
            </div>`;
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadTopCustomers() {
        try {
          const customers = await crudManager.getMergedData(
            "Customers.xml",
            "customer"
          );
          const top = customers.slice(0, 5);

          const html = top
            .map((c) => {
              const name = c.name || "N/A";
              const phone = c.phone || "N/A";
              const membership = c.membership || "Standard";
              const badgeClass =
                membership === "VIP"
                  ? "badge-warning"
                  : membership === "Gold"
                  ? "badge-warning"
                  : "badge-info";

              return `
                <div class="list-item">
                  <div class="list-left">
                    <div class="list-title">${name}</div>
                    <div class="list-sub">${phone}</div>
                  </div>
                  <span class="badge ${badgeClass}">${membership}</span>
                </div>
              `;
            })
            .join("");

          document.getElementById("topCustomers").innerHTML =
            html ||
            `<div class="empty-state">
              <i class="fas fa-users"></i>
              <div>No customers</div>
            </div>`;
        } catch (error) {
          console.error("Error:", error);
        }
      }
    </script>
  </body>
</html>
