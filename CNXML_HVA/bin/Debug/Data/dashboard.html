<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Football Field Management</title>

    <!-- Fonts (modern) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/dashboard.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/app.js"></script>
    <script src="js/crud.js"></script>
    <script src="js/components.js"></script>
  </head>

  <body class="dashboard-page">
    <!-- Sidebar -->
    <div id="sidebar"></div>

    <!-- Main Content -->
    <main class="dashboard-main">
      <!-- Hero -->
      <section class="hero">
        <div class="hero-content">
          <div class="hero-badge">
            <i class="fas fa-wave-square"></i>
            <span>Live Analytics</span>
          </div>

          <h1 class="hero-title">
            <i class="fas fa-chart-line"></i>
            Dashboard Overview
          </h1>
          <p class="hero-subtitle">
            Real-time statistics and analytics for football field management
          </p>
        </div>

        <div class="hero-icon">
          <i class="fas fa-futbol"></i>
        </div>
      </section>

      <!-- Stats -->
      <section class="section">
        <div class="stats-grid" id="statsCards"></div>
      </section>

      <!-- Revenue Trend -->
      <section class="section">
        <div class="card-modern">
          <div class="card-head">
            <h3>
              <i class="fas fa-chart-area"></i>
              Revenue Trend (Last 6 Months)
            </h3>
            <span class="pill">Line / Dual axis</span>
          </div>

          <div class="card-body">
            <div class="chart-wrap chart-lg">
              <canvas id="revenueTrendChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Charts row -->
      <section class="section grid-12">
        <div class="card-modern col-6">
          <div class="card-head">
            <h3><i class="fas fa-chart-pie"></i> Booking Status</h3>
            <span class="pill">Pie</span>
          </div>
          <div class="card-body">
            <div class="chart-wrap chart-md">
              <canvas id="bookingStatusChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card-modern col-6">
          <div class="card-head">
            <h3><i class="fas fa-circle-notch"></i> Field Utilization</h3>
            <span class="pill">Doughnut</span>
          </div>
          <div class="card-body">
            <div class="chart-wrap chart-md">
              <canvas id="fieldUtilizationChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Small charts -->
      <section class="section grid-12">
        <div class="card-modern col-4">
          <div class="card-head">
            <h3><i class="fas fa-users"></i> Customers</h3>
            <span class="pill">Bar</span>
          </div>
          <div class="card-body">
            <div class="chart-wrap chart-sm">
              <canvas id="customerChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card-modern col-4">
          <div class="card-head">
            <h3><i class="fas fa-tools"></i> Equipment</h3>
            <span class="pill">Doughnut</span>
          </div>
          <div class="card-body">
            <div class="chart-wrap chart-sm">
              <canvas id="equipmentChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card-modern col-4">
          <div class="card-head">
            <h3><i class="fas fa-building"></i> Branches</h3>
            <span class="pill">Bar</span>
          </div>
          <div class="card-body">
            <div class="chart-wrap chart-sm">
              <canvas id="branchChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Lists -->
      <section class="section grid-12">
        <div class="card-modern col-6">
          <div class="card-head">
            <h3><i class="fas fa-calendar-check"></i> Recent Bookings</h3>
            <span class="pill">Latest 5</span>
          </div>
          <div class="card-body">
            <div id="recentBookings" class="list"></div>
          </div>
        </div>

        <div class="card-modern col-6">
          <div class="card-head">
            <h3><i class="fas fa-star"></i> Top Customers</h3>
            <span class="pill">Top 5</span>
          </div>
          <div class="card-body">
            <div id="topCustomers" class="list"></div>
          </div>
        </div>
      </section>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        requireAuth();
        document.getElementById("sidebar").innerHTML =
          createSidebar("dashboard");

        // ===== Global Chart defaults (fix "chart quá to" + đẹp hơn) =====
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.color = "rgba(229,231,235,.75)";
        Chart.defaults.font.family =
          "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.legend.labels.boxWidth = 10;
        Chart.defaults.plugins.legend.labels.padding = 14;

        await Promise.all([
          loadStatsCards(),
          loadRevenueTrend(),
          loadBookingStatus(),
          loadFieldUtilization(),
          loadCustomerChart(),
          loadEquipmentChart(),
          loadBranchChart(),
          loadRecentBookings(),
          loadTopCustomers(),
        ]);
      });

      async function loadStatsCards() {
        try {
          const [branches, fields, bookings, customers] = await Promise.all([
            crudManager.getMergedData("Branches.xml", "branch"),
            crudManager.getMergedData("Fields.xml", "field"),
            crudManager.getMergedData("Bookings.xml", "booking"),
            crudManager.getMergedData("Customers.xml", "customer"),
          ]);

          const stats = [
            {
              icon: "building",
              label: "Chi nhánh",
              value: branches.length,
              bg: "linear-gradient(135deg, rgba(76,175,80,.95), rgba(102,187,106,.75))",
            },
            {
              icon: "map-marked-alt",
              label: "Sân bóng",
              value: fields.length,
              bg: "linear-gradient(135deg, rgba(33,150,243,.95), rgba(66,165,245,.75))",
            },
            {
              icon: "calendar-check",
              label: "Đặt lịch",
              value: bookings.length,
              bg: "linear-gradient(135deg, rgba(255,152,0,.95), rgba(255,167,38,.75))",
            },
            {
              icon: "users",
              label: "Khách hàng",
              value: customers.length,
              bg: "linear-gradient(135deg, rgba(156,39,176,.95), rgba(171,71,188,.75))",
            },
          ];

          const statsHTML = stats
            .map(
              (s) => `
              <div class="stat-card" style="background:${s.bg}">
                <div class="stat-top">
                  <div class="stat-label">${s.label}</div>
                  <div class="stat-chip">
                    <i class="fas fa-${s.icon}"></i>
                  </div>
                </div>
                <div class="stat-value" data-value="${s.value}">0</div>
                <div class="stat-hint">Updated just now</div>
              </div>
            `
            )
            .join("");

          document.getElementById("statsCards").innerHTML = statsHTML;

          document.querySelectorAll(".stat-value").forEach((el) => {
            const value = parseInt(el.dataset.value);
            animateValue(el, 0, value, 1200);
          });
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      async function loadRevenueTrend() {
        const ctx = document
          .getElementById("revenueTrendChart")
          .getContext("2d");

        const months = [
          "Tháng 7",
          "Tháng 8",
          "Tháng 9",
          "Tháng 10",
          "Tháng 11",
          "Tháng 12",
        ];
        const revenue = [
          50000000, 65000000, 55000000, 75000000, 85000000, 95000000,
        ];
        const bookings = [45, 58, 52, 68, 75, 82];

        new Chart(ctx, {
          type: "line",
          data: {
            labels: months,
            datasets: [
              {
                label: "Doanh thu (VNĐ)",
                data: revenue,
                borderColor: "rgba(76,175,80,1)",
                backgroundColor: "rgba(76,175,80,.10)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                yAxisID: "y",
              },
              {
                label: "Số lượng booking",
                data: bookings,
                borderColor: "rgba(33,150,243,1)",
                backgroundColor: "rgba(33,150,243,.10)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                yAxisID: "y1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: "index", intersect: false },
            plugins: {
              legend: { display: true, position: "top" },
              tooltip: {
                padding: 12,
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || "";
                    if (context.parsed.y !== null) {
                      if (context.datasetIndex === 0) {
                        label += ": " + formatCurrency(context.parsed.y);
                      } else {
                        label += ": " + context.parsed.y + " bookings";
                      }
                    }
                    return label;
                  },
                },
              },
            },
            scales: {
              x: {
                grid: { color: "rgba(255,255,255,.06)" },
                ticks: { color: "rgba(229,231,235,.75)" },
              },
              y: {
                type: "linear",
                display: true,
                position: "left",
                grid: { color: "rgba(255,255,255,.06)" },
                ticks: {
                  callback: (value) => value / 1000000 + "M",
                  color: "rgba(229,231,235,.75)",
                },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                grid: { drawOnChartArea: false },
                ticks: { color: "rgba(229,231,235,.75)" },
              },
            },
          },
        });
      }

      async function loadBookingStatus() {
        try {
          const bookings = await crudManager.getMergedData(
            "Bookings.xml",
            "booking"
          );

          const statusCounts = {
            Confirmed: 0,
            Pending: 0,
            Cancelled: 0,
            Completed: 0,
          };
          bookings.forEach((b) => {
            const status = b.status || "Pending";
            if (statusCounts[status] !== undefined) statusCounts[status]++;
          });

          const ctx = document
            .getElementById("bookingStatusChart")
            .getContext("2d");

          new Chart(ctx, {
            type: "pie",
            data: {
              labels: Object.keys(statusCounts),
              datasets: [
                {
                  data: Object.values(statusCounts),
                  backgroundColor: ["#4caf50", "#ff9800", "#f44336", "#2196f3"],
                  borderWidth: 2,
                  borderColor: "rgba(255,255,255,.9)",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: "bottom" },
                tooltip: { padding: 12 },
              },
            },
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadFieldUtilization() {
        try {
          const fields = await crudManager.getMergedData("Fields.xml", "field");
          const statusCounts = { Available: 0, Booked: 0, Maintenance: 0 };

          fields.forEach((f) => {
            const status = f.status || "Available";
            if (statusCounts[status] !== undefined) statusCounts[status]++;
          });

          const ctx = document
            .getElementById("fieldUtilizationChart")
            .getContext("2d");

          new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: Object.keys(statusCounts),
              datasets: [
                {
                  data: Object.values(statusCounts),
                  backgroundColor: ["#4caf50", "#ff9800", "#9e9e9e"],
                  borderWidth: 2,
                  borderColor: "rgba(255,255,255,.9)",
                  hoverOffset: 8,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "62%",
              plugins: {
                legend: { position: "bottom" },
                tooltip: { padding: 12 },
              },
            },
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadCustomerChart() {
        try {
          const customers = await crudManager.getMergedData(
            "Customers.xml",
            "customer"
          );
          const membershipCounts = { VIP: 0, Gold: 0, Silver: 0, None: 0 };

          customers.forEach((c) => {
            const m = c.membership || "None";
            if (membershipCounts[m] !== undefined) membershipCounts[m]++;
          });

          const ctx = document.getElementById("customerChart").getContext("2d");

          new Chart(ctx, {
            type: "bar",
            data: {
              labels: Object.keys(membershipCounts),
              datasets: [
                {
                  label: "Customers",
                  data: Object.values(membershipCounts),
                  backgroundColor: ["#ffd700", "#c0c0c0", "#cd7f32", "#9e9e9e"],
                  borderWidth: 0,
                  borderRadius: 10,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: { color: "rgba(229,231,235,.75)" },
                },
                y: {
                  beginAtZero: true,
                  grid: { color: "rgba(255,255,255,.06)" },
                  ticks: { color: "rgba(229,231,235,.75)" },
                },
              },
            },
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadEquipmentChart() {
        try {
          const equipments = await crudManager.getMergedData(
            "Equipments.xml",
            "equipment"
          );

          const totalAvailable = equipments.reduce(
            (sum, eq) => sum + parseInt(eq.quantity_available || 0),
            0
          );

          const totalRented = equipments.reduce((sum, eq) => {
            const total = parseInt(eq.quantity_total || 0);
            const available = parseInt(eq.quantity_available || 0);
            return sum + (total - available);
          }, 0);

          const ctx = document
            .getElementById("equipmentChart")
            .getContext("2d");

          new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: ["Available", "Rented"],
              datasets: [
                {
                  data: [totalAvailable, totalRented],
                  backgroundColor: ["#4caf50", "#ff9800"],
                  borderWidth: 2,
                  borderColor: "rgba(255,255,255,.9)",
                  hoverOffset: 8,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "62%",
              plugins: { legend: { position: "bottom" } },
            },
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadBranchChart() {
        try {
          const branches = await crudManager.getMergedData(
            "Branches.xml",
            "branch"
          );
          const names = branches.map((b) => b.name || b.code);
          const revenues = branches.map((b) =>
            parseInt(b.monthly_revenue || 0)
          );

          const ctx = document.getElementById("branchChart").getContext("2d");

          new Chart(ctx, {
            type: "bar",
            data: {
              labels: names,
              datasets: [
                {
                  label: "Revenue",
                  data: revenues,
                  backgroundColor: "rgba(76,175,80,.95)",
                  borderWidth: 0,
                  borderRadius: 10,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: { color: "rgba(229,231,235,.75)" },
                },
                y: {
                  beginAtZero: true,
                  grid: { color: "rgba(255,255,255,.06)" },
                  ticks: {
                    callback: (value) => value / 1000000 + "M",
                    color: "rgba(229,231,235,.75)",
                  },
                },
              },
            },
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadRecentBookings() {
        try {
          const bookings = await crudManager.getMergedData(
            "Bookings.xml",
            "booking"
          );
          const recent = bookings.slice(-5).reverse();

          const html = recent
            .map((b) => {
              const name = b.customer_name || b.customer || "N/A";
              const date = b.booking_date || b.date || "N/A";
              const time = b.booking_time || b.time || "N/A";
              const status = b.status || "Pending";
              const badgeClass =
                status === "Confirmed"
                  ? "badge-success"
                  : status === "Cancelled"
                  ? "badge-danger"
                  : status === "Completed"
                  ? "badge-info"
                  : "badge-warning";

              return `
                <div class="list-item">
                  <div class="list-left">
                    <div class="list-title">${name}</div>
                    <div class="list-sub">${date} • ${time}h</div>
                  </div>
                  <span class="badge ${badgeClass}">${status}</span>
                </div>
              `;
            })
            .join("");

          document.getElementById("recentBookings").innerHTML =
            html ||
            `<div class="empty-state">
              <i class="fas fa-inbox"></i>
              <div>Chưa có đặt lịch nào</div>
            </div>`;
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadTopCustomers() {
        try {
          const customers = await crudManager.getMergedData(
            "Customers.xml",
            "customer"
          );
          const top = customers.slice(0, 5);

          const html = top
            .map((c) => {
              const name = c.name || "N/A";
              const phone = c.phone || "N/A";
              const membership = c.membership || "Standard";
              const badgeClass =
                membership === "VIP"
                  ? "badge-warning"
                  : membership === "Gold"
                  ? "badge-warning"
                  : "badge-info";

              return `
                <div class="list-item">
                  <div class="list-left">
                    <div class="list-title">${name}</div>
                    <div class="list-sub">${phone}</div>
                  </div>
                  <span class="badge ${badgeClass}">${membership}</span>
                </div>
              `;
            })
            .join("");

          document.getElementById("topCustomers").innerHTML =
            html ||
            `<div class="empty-state">
              <i class="fas fa-users"></i>
              <div>No customers</div>
            </div>`;
        } catch (error) {
          console.error("Error:", error);
        }
      }
    </script>
  </body>
</html>
