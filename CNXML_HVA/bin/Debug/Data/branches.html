<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi nh√°nh - H·ªá Th·ªëng S√¢n B√≥ng</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/branches.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="js/app.js"></script>
    <script src="js/crud.js"></script>
    <script src="js/components.js"></script>
  </head>
  <body class="branches-page">
    <!-- Sidebar -->
    <div id="sidebar"></div>

    <!-- Main Content -->
    <div style="margin-left: 280px; padding: 30px">
      <!-- Header -->
      <div
        class="grass-pattern grass-overlay"
        style="padding: 40px 30px; border-radius: 16px; margin-bottom: 30px"
      >
        <div style="position: relative; z-index: 1">
          <h1
            style="
              color: white;
              font-size: 2.5em;
              margin-bottom: 10px;
              text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            "
          >
            <i class="fas fa-building"></i> Qu·∫£n L√Ω Chi Nh√°nh
          </h1>
          <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.1em">
            Qu·∫£n l√Ω th√¥ng tin chi nh√°nh v√† ƒë·ªãa ƒëi·ªÉm kinh doanh
          </p>
        </div>
      </div>

      <!-- Stats Cards -->
      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        "
      >
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            "
          >
            <i class="fas fa-building"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="totalBranches">0</div>
            <div class="stat-label">T·ªïng chi nh√°nh</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            "
          >
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="activeBranches">0</div>
            <div class="stat-label">ƒêang ho·∫°t ƒë·ªông</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            "
          >
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="totalCities">0</div>
            <div class="stat-label">Th√†nh ph·ªë</div>
          </div>
        </div>
      </div>

      <!-- Toolbar -->
      <div
        class="toolbar-container"
        style="
          background: white;
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 25px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        "
      >
        <div
          style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center"
        >
          <button class="btn btn-primary" onclick="showAddBranchForm()">
            <i class="fas fa-plus"></i> Th√™m Chi Nh√°nh
          </button>
          <div style="flex: 1; min-width: 250px">
            <input
              type="text"
              id="searchInput"
              placeholder="üîç T√¨m ki·∫øm chi nh√°nh..."
              style="
                width: 100%;
                padding: 10px 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
              "
            />
          </div>
          <select
            id="cityFilter"
            style="
              padding: 10px 15px;
              border: 1px solid #ddd;
              border-radius: 8px;
              min-width: 150px;
            "
          >
            <option value="">T·∫•t c·∫£ th√†nh ph·ªë</option>
          </select>
          <select
            id="statusFilter"
            style="
              padding: 10px 15px;
              border: 1px solid #ddd;
              border-radius: 8px;
              min-width: 150px;
            "
          >
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="Active">Ho·∫°t ƒë·ªông</option>
            <option value="Inactive">T·∫°m ƒë√≥ng</option>
          </select>
        </div>
      </div>

      <!-- Branches Grid -->
      <div
        id="branchesGrid"
        class="grid-container"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
          gap: 25px;
        "
      >
        <!-- Branches will be loaded here -->
      </div>
    </div>

    <script>
      let allBranches = [];
      let filteredBranches = [];

      // Initialize page
      document.addEventListener("DOMContentLoaded", async () => {
        // Load sidebar
        document.getElementById("sidebar").innerHTML =
          createSidebar("branches");

        // Check authentication
        requireAuth();

        // Load branches
        await loadBranches();

        // Setup event listeners
        setupEventListeners();
      });

      // Load branches from XML and localStorage
      async function loadBranches() {
        try {
          LoadingOverlay.show();
          allBranches = await crudManager.getMergedData(
            "Branches.xml",
            "branch"
          );
          console.log("Loaded branches:", allBranches);
          filteredBranches = [...allBranches];
          renderBranches();
          updateStats();
          populateFilters();
          LoadingOverlay.hide();
        } catch (error) {
          console.error("Error loading branches:", error);
          LoadingOverlay.hide();
          Toast.error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu chi nh√°nh");
        }
      }

      // Generate next branch ID
      function getNextBranchId() {
        const maxNum = allBranches.reduce((max, b) => {
          const id = b.machinhanh || b.code || b.id || "";
          const num = parseInt(id.replace(/\D/g, "") || "0");
          return num > max ? num : max;
        }, 0);
        return `CN${String(maxNum + 1).padStart(3, "0")}`;
      }

      // Render branches to grid
      function renderBranches() {
        const grid = document.getElementById("branchesGrid");

        if (filteredBranches.length === 0) {
          grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                        <i class="fas fa-building" style="font-size: 4em; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #999; font-size: 1.2em;">Kh√¥ng t√¨m th·∫•y chi nh√°nh n√†o</h3>
                    </div>
                `;
          return;
        }

        grid.innerHTML = filteredBranches
          .map((branch) => {
            const address = branch.address || {};
            const contact = branch.contact || {};
            const openingHours = branch.openinghours || {};
            const fullAddress = `${address.housenumber || ""} ${
              address.street || ""
            }, ${address.district || ""}, ${address.city || ""}`.trim();

            return `
                <div class="branch-card" style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s;">
                    <div style="position: relative;">
                        <img src="${
                          branch.image_url ||
                          "https://via.placeholder.com/400x200?text=No+Image"
                        }" 
                             alt="${branch.name || "Branch"}" 
                             style="width: 100%; height: 200px; object-fit: cover;"
                             onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
                        <span class="status-badge ${
                          branch.status === "Active"
                            ? "status-active"
                            : "status-inactive"
                        }" 
                              style="position: absolute; top: 15px; right: 15px; padding: 6px 12px; border-radius: 20px; font-size: 0.8em; color: white; font-weight: bold; background: ${
                                branch.status === "Active"
                                  ? "#4CAF50"
                                  : "#f44336"
                              };">
                            ${
                              branch.status === "Active"
                                ? "Ho·∫°t ƒë·ªông"
                                : "T·∫°m ƒë√≥ng"
                            }
                        </span>
                    </div>
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 15px;">
                            <h3 style="font-size: 1.4em; color: #333; margin-bottom: 5px;">${
                              branch.name || "N/A"
                            }</h3>
                            <span style="background: #4CAF50; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8em;">
                                ${branch.code || "N/A"}
                            </span>
                        </div>
                        <div style="margin: 15px 0; color: #555;">
                            <div style="display: flex; align-items: center; margin: 8px 0;">
                                <i class="fas fa-map-marker-alt" style="width: 20px; color: #4CAF50;"></i>
                                <span style="font-size: 0.9em;">${
                                  fullAddress || "N/A"
                                }</span>
                            </div>
                            <div style="display: flex; align-items: center; margin: 8px 0;">
                                <i class="fas fa-phone" style="width: 20px; color: #4CAF50;"></i>
                                <span style="font-size: 0.9em;">${
                                  contact.phone || "N/A"
                                }</span>
                            </div>
                            <div style="display: flex; align-items: center; margin: 8px 0;">
                                <i class="fas fa-envelope" style="width: 20px; color: #4CAF50;"></i>
                                <span style="font-size: 0.9em;">${
                                  contact.email || "N/A"
                                }</span>
                            </div>
                            <div style="display: flex; align-items: center; margin: 8px 0;">
                                <i class="fas fa-user" style="width: 20px; color: #4CAF50;"></i>
                                <span style="font-size: 0.9em;">Qu·∫£n l√Ω: ${
                                  branch.managername || "N/A"
                                }</span>
                            </div>
                        </div>
                        <div style="background: #f1f8f4; padding: 10px; border-radius: 8px; margin: 15px 0;">
                            <p style="font-size: 0.9em; color: #555; margin: 0;">${
                              branch.description || "Kh√¥ng c√≥ m√¥ t·∫£"
                            }</p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding-top: 15px; border-top: 1px solid #eee;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.3em; font-weight: bold; color: #4CAF50;">${
                                  branch.totalfields || "0"
                                }</div>
                                <div style="font-size: 0.8em; color: #666;">S√¢n</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.3em; font-weight: bold; color: #4CAF50;">${
                                  branch.staffcount || "0"
                                }</div>
                                <div style="font-size: 0.8em; color: #666;">Nh√¢n vi√™n</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.1em; font-weight: bold; color: #4CAF50;">${formatCurrency(
                                  branch.monthlyrevenue || 0
                                )}</div>
                                <div style="font-size: 0.8em; color: #666;">Doanh thu</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-sm btn-primary" onclick="editBranch('${
                              branch.id
                            }')" style="flex: 1;">
                                <i class="fas fa-edit"></i> S·ª≠a
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBranch('${
                              branch.id
                            }')" style="flex: 1;">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                        </div>
                    </div>
                </div>
            `;
          })
          .join("");
      }

      // Update statistics
      function updateStats() {
        document.getElementById("totalBranches").textContent =
          allBranches.length;
        document.getElementById("activeBranches").textContent =
          allBranches.filter((b) => b.status === "Active").length;

        const cities = [
          ...new Set(
            allBranches.map((b) =>
              b.address && b.address.city ? b.address.city : ""
            )
          ),
        ];
        document.getElementById("totalCities").textContent = cities.filter(
          (c) => c
        ).length;
      }

      // Populate filter dropdowns
      function populateFilters() {
        const cityFilter = document.getElementById("cityFilter");
        const cities = [
          ...new Set(
            allBranches
              .map((b) => (b.address && b.address.city ? b.address.city : ""))
              .filter((c) => c)
          ),
        ];

        cityFilter.innerHTML =
          '<option value="">T·∫•t c·∫£ th√†nh ph·ªë</option>' +
          cities
            .map((city) => `<option value="${city}">${city}</option>`)
            .join("");
      }

      // Setup event listeners
      function setupEventListeners() {
        const searchInput = document.getElementById("searchInput");
        const cityFilter = document.getElementById("cityFilter");
        const statusFilter = document.getElementById("statusFilter");

        searchInput.addEventListener("input", debounce(filterBranches, 300));
        cityFilter.addEventListener("change", filterBranches);
        statusFilter.addEventListener("change", filterBranches);
      }

      // Filter branches
      function filterBranches() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const cityFilter = document.getElementById("cityFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;

        filteredBranches = allBranches.filter((branch) => {
          const address = branch.address || {};
          const fullAddress = `${address.housenumber || ""} ${
            address.street || ""
          }, ${address.district || ""}, ${address.city || ""}`;

          const matchesSearch =
            !searchTerm ||
            (branch.name || "").toLowerCase().includes(searchTerm) ||
            (branch.code || "").toLowerCase().includes(searchTerm) ||
            fullAddress.toLowerCase().includes(searchTerm) ||
            (branch.managername || "").toLowerCase().includes(searchTerm);

          const matchesCity = !cityFilter || address.city === cityFilter;

          const matchesStatus = !statusFilter || branch.status === statusFilter;

          return matchesSearch && matchesCity && matchesStatus;
        });

        renderBranches();
      }

      // Show add branch form
      function showAddBranchForm() {
        const nextId = getNextBranchId();
        const formHTML = `
          <form id="branchForm" style="display: grid; gap: 15px;">
            <div class="form-group">
              <label>M√£ chi nh√°nh <span style="color: red;">*</span></label>
              <input type="text" name="machinhanh" required class="form-control" value="${nextId}">
            </div>
            <div class="form-group">
              <label>T√™n chi nh√°nh <span style="color: red;">*</span></label>
              <input type="text" name="tenchinhanh" required class="form-control" placeholder="Chi nh√°nh H√† N·ªôi">
            </div>
            <div class="form-group">
              <label>ƒê·ªãa ch·ªâ <span style="color: red;">*</span></label>
              <input type="text" name="diachi" required class="form-control" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n, th√†nh ph·ªë">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="tel" name="sdt" class="form-control" placeholder="0123456789" pattern="[0-9]{10,11}">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" class="form-control" placeholder="branch@example.com">
              </div>
            </div>
            <div class="form-group">
              <label>Qu·∫£n l√Ω chi nh√°nh</label>
              <input type="text" name="quanly" class="form-control" placeholder="T√™n ng∆∞·ªùi qu·∫£n l√Ω">
            </div>
            <div class="form-group">
              <label>M√¥ t·∫£</label>
              <textarea name="mota" class="form-control" rows="3" placeholder="M√¥ t·∫£ chi nh√°nh..."></textarea>
            </div>
            <div class="form-group">
              <label>H√¨nh ·∫£nh URL</label>
              <input type="url" name="hinhanh" class="form-control" placeholder="https://example.com/image.jpg">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>S·ªë s√¢n</label>
                <input type="number" name="sosan" class="form-control" value="0" min="0">
              </div>
              <div class="form-group">
                <label>S·ªë nh√¢n vi√™n</label>
                <input type="number" name="sonhanvien" class="form-control" value="0" min="0">
              </div>
              <div class="form-group">
                <label>Doanh thu/th√°ng</label>
                <input type="number" name="doanhthu" class="form-control" value="0" min="0" step="100000">
              </div>
            </div>
            <div class="form-group">
              <label>Tr·∫°ng th√°i</label>
              <select name="trangthai" class="form-control">
                <option value="Active">Ho·∫°t ƒë·ªông</option>
                <option value="Inactive">T·∫°m ƒë√≥ng</option>
              </select>
            </div>
          </form>
        `;

        formModal.show("Th√™m Chi Nh√°nh M·ªõi", formHTML, async (data) => {
          try {
            LoadingOverlay.show();
            if (!data.tenchinhanh || !data.diachi) {
              Toast.error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
              LoadingOverlay.hide();
              return;
            }
            data.id = data.machinhanh;
            await crudManager.saveToXML("Branches.xml", data, "create");
            formModal.close();
            Toast.success("Th√™m chi nh√°nh th√†nh c√¥ng!");
            await loadBranches();
          } catch (error) {
            console.error("Error adding branch:", error);
            Toast.error("L·ªói khi th√™m chi nh√°nh: " + error.message);
          } finally {
            LoadingOverlay.hide();
          }
        });
      }

      // View branch details
      function viewBranch(id) {
        const branch = allBranches.find(
          (b) => (b.id || b.machinhanh || b.code) === id
        );
        if (!branch) {
          Toast.error("Kh√¥ng t√¨m th·∫•y chi nh√°nh!");
          return;
        }

        const address = branch.address || {};
        const contact = branch.contact || {};
        const fullAddress =
          branch.diachi ||
          `${address.housenumber || ""} ${address.street || ""}, ${
            address.district || ""
          }, ${address.city || ""}`.trim();
        const phone = branch.sdt || contact.phone || "N/A";
        const email = branch.email || contact.email || "N/A";

        const content = `
          <div style="padding: 10px;">
            <div style="text-align: center; margin-bottom: 20px;">
              <img src="${
                branch.hinhanh ||
                branch.image_url ||
                "https://via.placeholder.com/400x200?text=No+Image"
              }" 
                   style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px;"
                   onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <h4 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Th√¥ng tin chi nh√°nh</h4>
                <table style="width: 100%;">
                  <tr><td style="padding: 8px 0; color: #666;">M√£ CN:</td><td style="font-weight: bold;">${
                    branch.machinhanh || branch.code
                  }</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">T√™n:</td><td style="font-weight: bold;">${
                    branch.tenchinhanh || branch.name
                  }</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">ƒê·ªãa ch·ªâ:</td><td>${fullAddress}</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">Qu·∫£n l√Ω:</td><td>${
                    branch.quanly || branch.managername || "N/A"
                  }</td></tr>
                </table>
              </div>
              <div>
                <h4 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-address-card"></i> Li√™n h·ªá & Th·ªëng k√™</h4>
                <table style="width: 100%;">
                  <tr><td style="padding: 8px 0; color: #666;">SƒêT:</td><td style="font-weight: bold;">${phone}</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">Email:</td><td>${email}</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">S·ªë s√¢n:</td><td style="font-weight: bold; color: #4CAF50;">${
                    branch.sosan || branch.totalfields || 0
                  }</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">Nh√¢n vi√™n:</td><td>${
                    branch.sonhanvien || branch.staffcount || 0
                  }</td></tr>
                </table>
              </div>
            </div>
            ${
              branch.mota || branch.description
                ? `
              <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <h4 style="color: #666; margin-bottom: 10px;"><i class="fas fa-align-left"></i> M√¥ t·∫£</h4>
                <p style="margin: 0;">${branch.mota || branch.description}</p>
              </div>
            `
                : ""
            }
          </div>
        `;
        detailModal.show(
          `Chi ti·∫øt chi nh√°nh - ${branch.tenchinhanh || branch.name}`,
          content
        );
      }

      // Edit branch
      async function editBranch(id) {
        const branch = allBranches.find(
          (b) => (b.id || b.machinhanh || b.code) === id
        );
        if (!branch) {
          Toast.error("Kh√¥ng t√¨m th·∫•y chi nh√°nh!");
          return;
        }

        // Get values from branch object (supporting both flat and nested structures)
        const address = branch.address || {};
        const contact = branch.contact || {};
        const machinhanh = branch.machinhanh || branch.code || "";
        const tenchinhanh = branch.tenchinhanh || branch.name || "";
        const diachi =
          branch.diachi ||
          `${address.housenumber || ""} ${address.street || ""}, ${
            address.district || ""
          }, ${address.city || ""}`.trim();
        const sdt = branch.sdt || contact.phone || "";
        const email = branch.email || contact.email || "";
        const quanly = branch.quanly || branch.managername || "";
        const mota = branch.mota || branch.description || "";
        const hinhanh = branch.hinhanh || branch.image_url || "";
        const sosan = branch.sosan || branch.totalfields || 0;
        const sonhanvien = branch.sonhanvien || branch.staffcount || 0;
        const doanhthu = branch.doanhthu || branch.monthlyrevenue || 0;
        const trangthai = branch.trangthai || branch.status || "Active";

        const formHTML = `
          <form id="branchForm" style="display: grid; gap: 15px;">
            <div class="form-group">
              <label>M√£ chi nh√°nh</label>
              <input type="text" name="machinhanh" class="form-control" value="${machinhanh}" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
              <label>T√™n chi nh√°nh <span style="color: red;">*</span></label>
              <input type="text" name="tenchinhanh" required class="form-control" value="${tenchinhanh}">
            </div>
            <div class="form-group">
              <label>ƒê·ªãa ch·ªâ <span style="color: red;">*</span></label>
              <input type="text" name="diachi" required class="form-control" value="${diachi}">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="tel" name="sdt" class="form-control" value="${sdt}">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" class="form-control" value="${email}">
              </div>
            </div>
            <div class="form-group">
              <label>Qu·∫£n l√Ω chi nh√°nh</label>
              <input type="text" name="quanly" class="form-control" value="${quanly}">
            </div>
            <div class="form-group">
              <label>M√¥ t·∫£</label>
              <textarea name="mota" class="form-control" rows="3">${mota}</textarea>
            </div>
            <div class="form-group">
              <label>H√¨nh ·∫£nh URL</label>
              <input type="url" name="hinhanh" class="form-control" value="${hinhanh}">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>S·ªë s√¢n</label>
                <input type="number" name="sosan" class="form-control" value="${sosan}" min="0">
              </div>
              <div class="form-group">
                <label>S·ªë nh√¢n vi√™n</label>
                <input type="number" name="sonhanvien" class="form-control" value="${sonhanvien}" min="0">
              </div>
              <div class="form-group">
                <label>Doanh thu/th√°ng</label>
                <input type="number" name="doanhthu" class="form-control" value="${doanhthu}" min="0" step="100000">
              </div>
            </div>
            <div class="form-group">
              <label>Tr·∫°ng th√°i</label>
              <select name="trangthai" class="form-control">
                <option value="Active" ${
                  trangthai === "Active" ? "selected" : ""
                }>Ho·∫°t ƒë·ªông</option>
                <option value="Inactive" ${
                  trangthai === "Inactive" ? "selected" : ""
                }>T·∫°m ƒë√≥ng</option>
              </select>
            </div>
          </form>
        `;

        formModal.show("Ch·ªânh S·ª≠a Chi Nh√°nh", formHTML, async (data) => {
          try {
            LoadingOverlay.show();
            data.id = branch.id || branch.machinhanh || branch.code;
            await crudManager.saveToXML("Branches.xml", data, "update");
            formModal.close();
            Toast.success("C·∫≠p nh·∫≠t chi nh√°nh th√†nh c√¥ng!");
            await loadBranches();
          } catch (error) {
            console.error("Error updating branch:", error);
            Toast.error("L·ªói khi c·∫≠p nh·∫≠t chi nh√°nh: " + error.message);
          } finally {
            LoadingOverlay.hide();
          }
        });
      }

      // Delete branch
      function deleteBranch(id) {
        const branch = allBranches.find(
          (b) => (b.id || b.machinhanh || b.code) === id
        );
        if (!branch) {
          Toast.error("Kh√¥ng t√¨m th·∫•y chi nh√°nh!");
          return;
        }

        const name = branch.tenchinhanh || branch.name || id;
        ConfirmDialog.show(
          `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a chi nh√°nh <strong>"${name}"</strong>?<br><small style="color: #666;">M√£ CN: ${
            branch.machinhanh || branch.code
          }</small>`,
          async () => {
            try {
              LoadingOverlay.show();
              await crudManager.saveToXML(
                "Branches.xml",
                { id: branch.id || branch.machinhanh || branch.code },
                "delete"
              );
              Toast.success("X√≥a chi nh√°nh th√†nh c√¥ng!");
              await loadBranches();
            } catch (error) {
              console.error("Error deleting branch:", error);
              Toast.error("L·ªói khi x√≥a chi nh√°nh: " + error.message);
            } finally {
              LoadingOverlay.hide();
            }
          },
          "X√°c Nh·∫≠n X√≥a"
        );
      }

      // Export branches to XML
      function exportBranchesXML() {
        crudManager.downloadXML("Branches.xml", "Branches", "branch");
        Toast.success("ƒê√£ xu·∫•t file Branches.xml!");
      }
    </script>
  </body>
</html>
