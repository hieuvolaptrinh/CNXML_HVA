<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kh√°ch h√†ng - H·ªá Th·ªëng S√¢n B√≥ng</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/customer.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="js/app.js"></script>
    <script src="js/crud.js"></script>
    <script src="js/components.js"></script>
  </head>
  <body class="customers-page">
    <div id="sidebar"></div>

    <div style="margin-left: 280px; padding: 30px">
      <div
        class="grass-pattern grass-overlay"
        style="padding: 40px 30px; border-radius: 16px; margin-bottom: 30px"
      >
        <div style="position: relative; z-index: 1">
          <h1
            style="
              color: white;
              font-size: 2.5em;
              margin-bottom: 10px;
              text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            "
          >
            <i class="fas fa-users"></i> Qu·∫£n L√Ω Kh√°ch H√†ng
          </h1>
          <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.1em">
            Qu·∫£n l√Ω th√¥ng tin kh√°ch h√†ng v√† th√†nh vi√™n
          </p>
        </div>
      </div>

      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        "
      >
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            "
          >
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="totalCustomers">0</div>
            <div class="stat-label">T·ªïng kh√°ch h√†ng</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            "
          >
            <i class="fas fa-star"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="vipCustomers">0</div>
            <div class="stat-label">Kh√°ch VIP</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            "
          >
            <i class="fas fa-user-check"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="activeCustomers">0</div>
            <div class="stat-label">ƒêang ho·∫°t ƒë·ªông</div>
          </div>
        </div>
      </div>

      <div
        class="toolbar-container"
        style="
          background: white;
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 25px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        "
      >
        <div
          style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center"
        >
          <button class="btn btn-primary" onclick="showAddCustomerForm()">
            <i class="fas fa-plus"></i> Th√™m Kh√°ch H√†ng
          </button>
          <div style="flex: 1; min-width: 250px">
            <input
              type="text"
              id="searchInput"
              placeholder="üîç T√¨m ki·∫øm kh√°ch h√†ng..."
              style="
                width: 100%;
                padding: 10px 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
              "
            />
          </div>
          <select
            id="typeFilter"
            style="
              padding: 10px 15px;
              border: 1px solid #ddd;
              border-radius: 8px;
              min-width: 150px;
            "
          >
            <option value="">T·∫•t c·∫£ lo·∫°i</option>
            <option value="VIP">VIP</option>
            <option value="Regular">Th∆∞·ªùng</option>
          </select>
        </div>
      </div>

      <div
        id="customersGrid"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
          gap: 25px;
        "
      ></div>
    </div>

    <script>
      let allCustomers = [];
      let filteredCustomers = [];

      document.addEventListener("DOMContentLoaded", async () => {
        document.getElementById("sidebar").innerHTML =
          createSidebar("customers");
        requireAuth();
        await loadCustomers();
        setupEventListeners();
      });

      async function loadCustomers() {
        try {
          LoadingOverlay.show();
          allCustomers = await crudManager.getMergedData(
            "Customers.xml",
            "customer"
          );
          console.log("Loaded customers:", allCustomers);
          filteredCustomers = [...allCustomers];
          renderCustomers();
          updateStats();
          LoadingOverlay.hide();
        } catch (error) {
          console.error("Error loading customers:", error);
          LoadingOverlay.hide();
          Toast.error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu kh√°ch h√†ng");
        }
      }

      // Generate next customer ID
      function getNextCustomerId() {
        const maxNum = allCustomers.reduce((max, c) => {
          const id = c.makhachhang || c.id || "";
          const num = parseInt(id.replace(/\D/g, "") || "0");
          return num > max ? num : max;
        }, 0);
        return `KH${String(maxNum + 1).padStart(3, "0")}`;
      }

      function renderCustomers() {
        const grid = document.getElementById("customersGrid");

        if (filteredCustomers.length === 0) {
          grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                        <i class="fas fa-users" style="font-size: 4em; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #999; font-size: 1.2em;">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng n√†o</h3>
                    </div>
                `;
          return;
        }

        grid.innerHTML = filteredCustomers
          .map((customer) => {
            const isVIP = customer.loaikhachhang === "VIP";

            return `
                    <div class="customer-card" style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s;">
                        <div style="background: ${
                          isVIP
                            ? "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"
                            : "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
                        }; padding: 25px; text-align: center; color: white; position: relative;">
                            <div style="width: 80px; height: 80px; background: white; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user" style="font-size: 2.5em; color: ${
                                  isVIP ? "#f5576c" : "#667eea"
                                };"></i>
                            </div>
                            ${
                              isVIP
                                ? '<span style="position: absolute; top: 15px; right: 15px; background: gold; color: #333; padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold;"><i class="fas fa-crown"></i> VIP</span>'
                                : ""
                            }
                        </div>
                        <div style="padding: 20px;">
                            <div style="text-align: center; margin-bottom: 15px;">
                                <h3 style="font-size: 1.4em; color: #333; margin-bottom: 5px;">${
                                  customer.tenkhachhang || "N/A"
                                }</h3>
                                <span style="background: ${
                                  isVIP ? "#f5576c" : "#4CAF50"
                                }; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8em;">
                                    ${customer.makhachhang || "N/A"}
                                </span>
                            </div>
                            <div style="margin: 15px 0; color: #555;">
                                <div style="display: flex; align-items: center; margin: 8px 0;">
                                    <i class="fas fa-phone" style="width: 20px; color: ${
                                      isVIP ? "#f5576c" : "#667eea"
                                    };"></i>
                                    <span style="font-size: 0.9em;">${
                                      customer.sdt || "N/A"
                                    }</span>
                                </div>
                                <div style="display: flex; align-items: center; margin: 8px 0;">
                                    <i class="fas fa-envelope" style="width: 20px; color: ${
                                      isVIP ? "#f5576c" : "#667eea"
                                    };"></i>
                                    <span style="font-size: 0.9em;">${
                                      customer.email || "N/A"
                                    }</span>
                                </div>
                                <div style="display: flex; align-items: center; margin: 8px 0;">
                                    <i class="fas fa-map-marker-alt" style="width: 20px; color: ${
                                      isVIP ? "#f5576c" : "#667eea"
                                    };"></i>
                                    <span style="font-size: 0.9em;">${
                                      customer.diachi || "N/A"
                                    }</span>
                                </div>
                                <div style="display: flex; align-items: center; margin: 8px 0;">
                                    <i class="fas fa-calendar" style="width: 20px; color: ${
                                      isVIP ? "#f5576c" : "#667eea"
                                    };"></i>
                                    <span style="font-size: 0.9em;">Ng√†y sinh: ${formatDate(
                                      customer.ngaysinh
                                    )}</span>
                                </div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 15px 0; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: ${
                                  isVIP ? "#f5576c" : "#4CAF50"
                                };">
                                    ${customer.sodatsan || 0} l·∫ßn ƒë·∫∑t
                                </div>
                                <div style="font-size: 0.85em; color: #666; margin-top: 5px;">T·ªïng s·ªë l·∫ßn ƒë·∫∑t s√¢n</div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 15px;">
                                <button class="btn btn-sm btn-info" onclick="viewCustomer('${
                                  customer.id || customer.makhachhang
                                }')" style="flex: 1;" title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="editCustomer('${
                                  customer.id || customer.makhachhang
                                }')" style="flex: 1;" title="S·ª≠a">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${
                                  customer.id || customer.makhachhang
                                }')" style="flex: 1;" title="X√≥a">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function updateStats() {
        document.getElementById("totalCustomers").textContent =
          allCustomers.length;
        document.getElementById("vipCustomers").textContent =
          allCustomers.filter((c) => c.loaikhachhang === "VIP").length;
        document.getElementById("activeCustomers").textContent =
          allCustomers.filter((c) => (parseInt(c.sodatsan) || 0) > 0).length;
      }

      function setupEventListeners() {
        document
          .getElementById("searchInput")
          .addEventListener("input", debounce(filterCustomers, 300));
        document
          .getElementById("typeFilter")
          .addEventListener("change", filterCustomers);
      }

      function filterCustomers() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const typeFilter = document.getElementById("typeFilter").value;

        filteredCustomers = allCustomers.filter((customer) => {
          const matchesSearch =
            !searchTerm ||
            (customer.tenkhachhang || "").toLowerCase().includes(searchTerm) ||
            (customer.makhachhang || "").toLowerCase().includes(searchTerm) ||
            (customer.sdt || "").toLowerCase().includes(searchTerm) ||
            (customer.email || "").toLowerCase().includes(searchTerm);

          const matchesType =
            !typeFilter || customer.loaikhachhang === typeFilter;

          return matchesSearch && matchesType;
        });

        renderCustomers();
      }

      function showAddCustomerForm() {
        const nextId = getNextCustomerId();
        const formHTML = `
          <form id="customerForm" style="display: grid; gap: 15px;">
            <div class="form-group">
              <label>M√£ kh√°ch h√†ng <span style="color: red;">*</span></label>
              <input type="text" name="makhachhang" required class="form-control" value="${nextId}">
            </div>
            <div class="form-group">
              <label>T√™n kh√°ch h√†ng <span style="color: red;">*</span></label>
              <input type="text" name="tenkhachhang" required class="form-control" placeholder="Nguy·ªÖn VƒÉn A">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>S·ªë ƒëi·ªán tho·∫°i <span style="color: red;">*</span></label>
                <input type="tel" name="sdt" required class="form-control" placeholder="0123456789" pattern="[0-9]{10,11}">
              </div>
              <div class="form-group">
                <label>Ng√†y sinh</label>
                <input type="date" name="ngaysinh" class="form-control">
              </div>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" name="email" class="form-control" placeholder="email@example.com">
            </div>
            <div class="form-group">
              <label>ƒê·ªãa ch·ªâ</label>
              <input type="text" name="diachi" class="form-control" placeholder="S·ªë nh√†, ƒê∆∞·ªùng, Qu·∫≠n/Huy·ªán, Th√†nh ph·ªë">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Lo·∫°i kh√°ch h√†ng</label>
                <select name="loaikhachhang" class="form-control">
                  <option value="Regular">Th∆∞·ªùng</option>
                  <option value="VIP">VIP</option>
                </select>
              </div>
              <div class="form-group">
                <label>S·ªë l·∫ßn ƒë·∫∑t s√¢n</label>
                <input type="number" name="sodatsan" class="form-control" value="0" min="0">
              </div>
            </div>
            <div class="alert" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px;">
              <i class="fas fa-info-circle" style="color: #4CAF50;"></i>
              <span style="color: #2e7d32;">Kh√°ch VIP s·∫Ω ƒë∆∞·ª£c ∆∞u ti√™n ƒë·∫∑t s√¢n v√† nh·∫≠n ∆∞u ƒë√£i ƒë·∫∑c bi·ªát!</span>
            </div>
          </form>
        `;

        formModal.show("Th√™m Kh√°ch H√†ng M·ªõi", formHTML, async (data) => {
          try {
            LoadingOverlay.show();
            // Validate
            if (!data.tenkhachhang || !data.sdt) {
              Toast.error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
              LoadingOverlay.hide();
              return;
            }
            data.id = data.makhachhang;
            await crudManager.saveToXML("Customers.xml", data, "create");
            formModal.close();
            Toast.success("Th√™m kh√°ch h√†ng th√†nh c√¥ng!");
            await loadCustomers();
          } catch (error) {
            console.error("Error adding customer:", error);
            Toast.error("L·ªói khi th√™m kh√°ch h√†ng: " + error.message);
          } finally {
            LoadingOverlay.hide();
          }
        });
      }

      function viewCustomer(id) {
        const customer = allCustomers.find(
          (c) => (c.id || c.makhachhang) === id
        );
        if (!customer) {
          Toast.error("Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng!");
          return;
        }

        const isVIP = customer.loaikhachhang === "VIP";
        const content = `
          <div style="padding: 10px;">
            <div style="text-align: center; margin-bottom: 25px;">
              <div style="width: 100px; height: 100px; background: ${
                isVIP
                  ? "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"
                  : "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
              }; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-user" style="font-size: 3em; color: white;"></i>
              </div>
              <h2 style="color: #333; margin: 0;">${customer.tenkhachhang}</h2>
              <span style="background: ${
                isVIP ? "#f5576c" : "#4CAF50"
              }; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; display: inline-block; margin-top: 10px;">
                ${
                  isVIP
                    ? '<i class="fas fa-crown"></i> VIP'
                    : '<i class="fas fa-user"></i> Th∆∞·ªùng'
                }
              </span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <h4 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Th√¥ng tin c∆° b·∫£n</h4>
                <table style="width: 100%;">
                  <tr><td style="padding: 8px 0; color: #666;">M√£ KH:</td><td style="font-weight: bold;">${
                    customer.makhachhang
                  }</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">Ng√†y sinh:</td><td>${
                    formatDate(customer.ngaysinh) || "Ch∆∞a c·∫≠p nh·∫≠t"
                  }</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">S·ªë ƒë·∫∑t s√¢n:</td><td style="font-weight: bold; color: #4CAF50;">${
                    customer.sodatsan || 0
                  } l·∫ßn</td></tr>
                </table>
              </div>
              <div>
                <h4 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-address-card"></i> Li√™n h·ªá</h4>
                <table style="width: 100%;">
                  <tr><td style="padding: 8px 0; color: #666;">SƒêT:</td><td style="font-weight: bold;">${
                    customer.sdt
                  }</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">Email:</td><td>${
                    customer.email || "Ch∆∞a c·∫≠p nh·∫≠t"
                  }</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">ƒê·ªãa ch·ªâ:</td><td>${
                    customer.diachi || "Ch∆∞a c·∫≠p nh·∫≠t"
                  }</td></tr>
                </table>
              </div>
            </div>
          </div>
        `;
        detailModal.show(
          `Chi ti·∫øt kh√°ch h√†ng - ${customer.tenkhachhang}`,
          content
        );
      }

      async function editCustomer(id) {
        const customer = allCustomers.find(
          (c) => (c.id || c.makhachhang) === id
        );
        if (!customer) {
          Toast.error("Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng!");
          return;
        }

        const formHTML = `
          <form id="customerForm" style="display: grid; gap: 15px;">
            <div class="form-group">
              <label>M√£ kh√°ch h√†ng</label>
              <input type="text" name="makhachhang" class="form-control" value="${
                customer.makhachhang || ""
              }" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
              <label>T√™n kh√°ch h√†ng <span style="color: red;">*</span></label>
              <input type="text" name="tenkhachhang" required class="form-control" value="${
                customer.tenkhachhang || ""
              }">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>S·ªë ƒëi·ªán tho·∫°i <span style="color: red;">*</span></label>
                <input type="tel" name="sdt" required class="form-control" value="${
                  customer.sdt || ""
                }" pattern="[0-9]{10,11}">
              </div>
              <div class="form-group">
                <label>Ng√†y sinh</label>
                <input type="date" name="ngaysinh" class="form-control" value="${
                  customer.ngaysinh || ""
                }">
              </div>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" name="email" class="form-control" value="${
                customer.email || ""
              }">
            </div>
            <div class="form-group">
              <label>ƒê·ªãa ch·ªâ</label>
              <input type="text" name="diachi" class="form-control" value="${
                customer.diachi || ""
              }">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Lo·∫°i kh√°ch h√†ng</label>
                <select name="loaikhachhang" class="form-control">
                  <option value="Regular" ${
                    customer.loaikhachhang !== "VIP" ? "selected" : ""
                  }>Th∆∞·ªùng</option>
                  <option value="VIP" ${
                    customer.loaikhachhang === "VIP" ? "selected" : ""
                  }>VIP</option>
                </select>
              </div>
              <div class="form-group">
                <label>S·ªë l·∫ßn ƒë·∫∑t s√¢n</label>
                <input type="number" name="sodatsan" class="form-control" value="${
                  customer.sodatsan || 0
                }" min="0">
              </div>
            </div>
          </form>
        `;

        formModal.show("Ch·ªânh S·ª≠a Kh√°ch H√†ng", formHTML, async (data) => {
          try {
            LoadingOverlay.show();
            data.id = customer.id || customer.makhachhang;
            await crudManager.saveToXML("Customers.xml", data, "update");
            formModal.close();
            Toast.success("C·∫≠p nh·∫≠t kh√°ch h√†ng th√†nh c√¥ng!");
            await loadCustomers();
          } catch (error) {
            console.error("Error updating customer:", error);
            Toast.error("L·ªói khi c·∫≠p nh·∫≠t kh√°ch h√†ng: " + error.message);
          } finally {
            LoadingOverlay.hide();
          }
        });
      }

      function deleteCustomer(id) {
        const customer = allCustomers.find(
          (c) => (c.id || c.makhachhang) === id
        );
        if (!customer) {
          Toast.error("Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng!");
          return;
        }

        ConfirmDialog.show(
          `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng <strong>"${customer.tenkhachhang}"</strong>?<br><small style="color: #666;">M√£ KH: ${customer.makhachhang}</small>`,
          async () => {
            try {
              LoadingOverlay.show();
              await crudManager.saveToXML(
                "Customers.xml",
                { id: customer.id || customer.makhachhang },
                "delete"
              );
              Toast.success("X√≥a kh√°ch h√†ng th√†nh c√¥ng!");
              await loadCustomers();
            } catch (error) {
              console.error("Error deleting customer:", error);
              Toast.error("L·ªói khi x√≥a kh√°ch h√†ng: " + error.message);
            } finally {
              LoadingOverlay.hide();
            }
          },
          "X√°c Nh·∫≠n X√≥a"
        );
      }

      // Export customers to XML
      function exportCustomersXML() {
        crudManager.downloadXML("Customers.xml", "Customers", "customer");
        Toast.success("ƒê√£ xu·∫•t file Customers.xml!");
      }
    </script>
  </body>
</html>
