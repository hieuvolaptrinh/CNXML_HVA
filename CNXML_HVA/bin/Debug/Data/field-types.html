<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lo·∫°i s√¢n - H·ªá Th·ªëng S√¢n B√≥ng</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/field-types.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="js/app.js"></script>
    <script src="js/crud.js"></script>
    <script src="js/components.js"></script>
  </head>
  <body class="field-types-page">
    <div id="sidebar"></div>

    <div style="margin-left: 280px; padding: 30px">
      <div
        class="grass-pattern grass-overlay"
        style="padding: 40px 30px; border-radius: 16px; margin-bottom: 30px"
      >
        <div style="position: relative; z-index: 1">
          <h1
            style="
              color: white;
              font-size: 2.5em;
              margin-bottom: 10px;
              text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            "
          >
            <i class="fas fa-list"></i> Qu·∫£n L√Ω Lo·∫°i S√¢n
          </h1>
          <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.1em">
            Ph√¢n lo·∫°i v√† qu·∫£n l√Ω c√°c lo·∫°i s√¢n b√≥ng
          </p>
        </div>
      </div>

      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        "
      >
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            "
          >
            <i class="fas fa-layer-group"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="totalTypes">0</div>
            <div class="stat-label">T·ªïng lo·∫°i s√¢n</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            "
          >
            <i class="fas fa-futbol"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="mostPopular">N/A</div>
            <div class="stat-label">Ph·ªï bi·∫øn nh·∫•t</div>
          </div>
        </div>
      </div>

      <div
        class="toolbar-container"
        style="
          background: white;
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 25px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        "
      >
        <div
          style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center"
        >
          <button class="btn btn-primary" onclick="showAddFieldTypeForm()">
            <i class="fas fa-plus"></i> Th√™m Lo·∫°i S√¢n
          </button>
          <div style="flex: 1; min-width: 250px">
            <input
              type="text"
              id="searchInput"
              placeholder="üîç T√¨m ki·∫øm lo·∫°i s√¢n..."
              style="
                width: 100%;
                padding: 10px 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
              "
            />
          </div>
        </div>
      </div>

      <div
        id="fieldTypesGrid"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
          gap: 25px;
        "
      ></div>
    </div>

    <script>
      let allFieldTypes = [];
      let filteredFieldTypes = [];

      document.addEventListener("DOMContentLoaded", async () => {
        document.getElementById("sidebar").innerHTML =
          createSidebar("field-types");
        requireAuth();
        await loadFieldTypes();
        setupEventListeners();
      });

      async function loadFieldTypes() {
        try {
          LoadingOverlay.show();
          allFieldTypes = await crudManager.getMergedData(
            "FieldTypes.xml",
            "fieldType"
          );
          console.log("Loaded field types:", allFieldTypes);
          filteredFieldTypes = [...allFieldTypes];
          renderFieldTypes();
          updateStats();
          LoadingOverlay.hide();
        } catch (error) {
          console.error("Error loading field types:", error);
          LoadingOverlay.hide();
          Toast.error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu lo·∫°i s√¢n");
        }
      }

      // Generate next field type ID
      function getNextFieldTypeId() {
        const maxNum = allFieldTypes.reduce((max, t) => {
          const id = t.maloaisan || t.code || t.id || "";
          const num = parseInt(id.replace(/\D/g, "") || "0");
          return num > max ? num : max;
        }, 0);
        return `LS${String(maxNum + 1).padStart(3, "0")}`;
      }

      function renderFieldTypes() {
        const grid = document.getElementById("fieldTypesGrid");

        if (filteredFieldTypes.length === 0) {
          grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                        <i class="fas fa-list" style="font-size: 4em; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #999; font-size: 1.2em;">Kh√¥ng t√¨m th·∫•y lo·∫°i s√¢n n√†o</h3>
                    </div>
                `;
          return;
        }

        grid.innerHTML = filteredFieldTypes
          .map(
            (type) => `
                <div class="field-type-card" style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; color: white;">
                        <i class="fas fa-futbol" style="font-size: 3em; margin-bottom: 15px;"></i>
                        <h3 style="font-size: 1.5em; margin-bottom: 5px;">${
                          type.tenloaisan || type.name || "N/A"
                        }</h3>
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.9em;">
                            ${type.maloaisan || type.code || type.id || "N/A"}
                        </span>
                    </div>
                    <div style="padding: 20px;">
                        <div style="margin: 15px 0; color: #555;">
                            <div style="display: flex; align-items: center; margin: 10px 0;">
                                <i class="fas fa-users" style="width: 25px; color: #667eea;"></i>
                                <span style="font-size: 0.95em;">S·ªë ng∆∞·ªùi: <strong>${
                                  type.songuoi || type.total_capacity || "N/A"
                                }</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; margin: 10px 0;">
                                <i class="fas fa-ruler-combined" style="width: 25px; color: #667eea;"></i>
                                <span style="font-size: 0.95em;">K√≠ch th∆∞·ªõc: <strong>${
                                  type.kichthuoc || type.size_display || "N/A"
                                }</strong></span>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 15px 0;">
                            <p style="font-size: 0.9em; color: #555; margin: 0;">${
                              type.mota || type.description || "Kh√¥ng c√≥ m√¥ t·∫£"
                            }</p>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-sm btn-primary" onclick="editFieldType('${
                              type.maloaisan || type.id
                            }')" style="flex: 1;">
                                <i class="fas fa-edit"></i> S·ª≠a
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFieldType('${
                              type.maloaisan || type.id
                            }')" style="flex: 1;">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function updateStats() {
        document.getElementById("totalTypes").textContent =
          allFieldTypes.length;

        if (allFieldTypes.length > 0) {
          const mostPopular = allFieldTypes[0];
          document.getElementById("mostPopular").textContent =
            mostPopular.tenloaisan || "N/A";
        }
      }

      function setupEventListeners() {
        document
          .getElementById("searchInput")
          .addEventListener("input", debounce(filterFieldTypes, 300));
      }

      function filterFieldTypes() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();

        filteredFieldTypes = allFieldTypes.filter((type) => {
          return (
            !searchTerm ||
            (type.tenloaisan || "").toLowerCase().includes(searchTerm) ||
            (type.maloaisan || "").toLowerCase().includes(searchTerm) ||
            (type.songuoi || "").toLowerCase().includes(searchTerm)
          );
        });

        renderFieldTypes();
      }

      function showAddFieldTypeForm() {
        const nextId = getNextFieldTypeId();
        const formHTML = `
          <form id="fieldTypeForm" style="display: grid; gap: 15px;">
            <div class="form-group">
              <label>M√£ lo·∫°i s√¢n <span style="color: red;">*</span></label>
              <input type="text" name="maloaisan" required class="form-control" value="${nextId}">
            </div>
            <div class="form-group">
              <label>T√™n lo·∫°i s√¢n <span style="color: red;">*</span></label>
              <input type="text" name="tenloaisan" required class="form-control" placeholder="S√¢n 5 ng∆∞·ªùi">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>S·ªë ng∆∞·ªùi <span style="color: red;">*</span></label>
                <select name="songuoi" required class="form-control">
                  <option value="">Ch·ªçn s·ªë ng∆∞·ªùi</option>
                  <option value="5 ng∆∞·ªùi">5 ng∆∞·ªùi</option>
                  <option value="7 ng∆∞·ªùi">7 ng∆∞·ªùi</option>
                  <option value="11 ng∆∞·ªùi">11 ng∆∞·ªùi</option>
                </select>
              </div>
              <div class="form-group">
                <label>K√≠ch th∆∞·ªõc</label>
                <select name="kichthuoc" class="form-control">
                  <option value="">Ch·ªçn k√≠ch th∆∞·ªõc</option>
                  <option value="20m x 40m">20m x 40m (S√¢n 5)</option>
                  <option value="30m x 50m">30m x 50m (S√¢n 7)</option>
                  <option value="68m x 105m">68m x 105m (S√¢n 11)</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>M√¥ t·∫£</label>
              <textarea name="mota" class="form-control" rows="3" placeholder="M√¥ t·∫£ ƒë·∫∑c ƒëi·ªÉm lo·∫°i s√¢n..."></textarea>
            </div>
          </form>
        `;

        formModal.show("Th√™m Lo·∫°i S√¢n M·ªõi", formHTML, async (data) => {
          try {
            LoadingOverlay.show();
            if (!data.tenloaisan || !data.songuoi) {
              Toast.error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
              LoadingOverlay.hide();
              return;
            }
            data.id = data.maloaisan;
            await crudManager.saveToXML("FieldTypes.xml", data, "create");
            formModal.close();
            Toast.success("Th√™m lo·∫°i s√¢n th√†nh c√¥ng!");
            await loadFieldTypes();
          } catch (error) {
            console.error("Error adding field type:", error);
            Toast.error("L·ªói khi th√™m lo·∫°i s√¢n: " + error.message);
          } finally {
            LoadingOverlay.hide();
          }
        });
      }

      function viewFieldType(id) {
        const type = allFieldTypes.find(
          (t) => (t.maloaisan || t.code || t.id) === id
        );
        if (!type) {
          Toast.error("Kh√¥ng t√¨m th·∫•y lo·∫°i s√¢n!");
          return;
        }

        const content = `
          <div style="padding: 10px;">
            <div style="text-align: center; margin-bottom: 25px;">
              <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-futbol" style="font-size: 2.5em; color: white;"></i>
              </div>
              <h2 style="color: #333; margin: 0;">${
                type.tenloaisan || type.name
              }</h2>
              <span style="background: #667eea; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; display: inline-block; margin-top: 10px;">
                ${type.maloaisan || type.code || type.id}
              </span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div style="padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                <i class="fas fa-users" style="font-size: 2em; color: #667eea; margin-bottom: 10px;"></i>
                <h4 style="margin: 0; color: #333;">S·ªë ng∆∞·ªùi</h4>
                <p style="font-size: 1.2em; font-weight: bold; color: #4CAF50; margin: 10px 0 0;">${
                  type.songuoi || type.total_capacity || "N/A"
                }</p>
              </div>
              <div style="padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                <i class="fas fa-ruler-combined" style="font-size: 2em; color: #667eea; margin-bottom: 10px;"></i>
                <h4 style="margin: 0; color: #333;">K√≠ch th∆∞·ªõc</h4>
                <p style="font-size: 1.2em; font-weight: bold; color: #4CAF50; margin: 10px 0 0;">${
                  type.kichthuoc || type.size_display || "N/A"
                }</p>
              </div>
            </div>
            ${
              type.mota || type.description
                ? `
              <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <h4 style="color: #666; margin-bottom: 10px;"><i class="fas fa-align-left"></i> M√¥ t·∫£</h4>
                <p style="margin: 0;">${type.mota || type.description}</p>
              </div>
            `
                : ""
            }
          </div>
        `;
        detailModal.show(
          `Chi ti·∫øt lo·∫°i s√¢n - ${type.tenloaisan || type.name}`,
          content
        );
      }

      // Generate field type options for reference
      function getFieldTypeReferenceOptions(selectedType = "", excludeId = "") {
        return allFieldTypes
          .filter((ft) => (ft.maloaisan || ft.id || ft.code) !== excludeId)
          .map((ft) => {
            const id = ft.maloaisan || ft.id || ft.code;
            const name = ft.tenloaisan || ft.name || id;
            const selected = id === selectedType ? "selected" : "";
            return `<option value="${id}" ${selected}>${name}</option>`;
          })
          .join("");
      }

      async function editFieldType(id) {
        const type = allFieldTypes.find(
          (t) => (t.maloaisan || t.code || t.id) === id
        );
        if (!type) {
          Toast.error("Kh√¥ng t√¨m th·∫•y lo·∫°i s√¢n!");
          return;
        }

        const maloaisan = type.maloaisan || type.code || "";
        const tenloaisan = type.tenloaisan || type.name || "";
        const songuoi = type.songuoi || type.total_capacity || "";
        const kichthuoc = type.kichthuoc || type.size_display || "";
        const mota = type.mota || type.description || "";

        const formHTML = `
          <form id="fieldTypeForm" style="display: grid; gap: 15px;">
            <div class="form-group">
              <label>M√£ lo·∫°i s√¢n</label>
              <input type="text" name="maloaisan" class="form-control" value="${maloaisan}" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
              <label>T√™n lo·∫°i s√¢n <span style="color: red;">*</span></label>
              <input type="text" name="tenloaisan" required class="form-control" value="${tenloaisan}">
            </div>
            <div class="form-group">
              <label>Tham kh·∫£o t·ª´ lo·∫°i s√¢n kh√°c (t√πy ch·ªçn)</label>
              <select name="referenceType" class="form-control" id="fieldTypeReferenceSelect">
                <option value="">-- Ch·ªçn lo·∫°i s√¢n ƒë·ªÉ tham kh·∫£o --</option>
                ${getFieldTypeReferenceOptions("", id)}
              </select>
              <small style="color: #666; font-size: 0.85em;">Ch·ªçn lo·∫°i s√¢n kh√°c ƒë·ªÉ copy th√¥ng tin</small>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>S·ªë ng∆∞·ªùi <span style="color: red;">*</span></label>
                <select name="songuoi" required class="form-control" id="fieldTypeSonguoi">
                  <option value="">Ch·ªçn s·ªë ng∆∞·ªùi</option>
                  <option value="5 ng∆∞·ªùi" ${
                    songuoi === "5 ng∆∞·ªùi" || songuoi === "5" ? "selected" : ""
                  }>5 ng∆∞·ªùi</option>
                  <option value="7 ng∆∞·ªùi" ${
                    songuoi === "7 ng∆∞·ªùi" || songuoi === "7" ? "selected" : ""
                  }>7 ng∆∞·ªùi</option>
                  <option value="11 ng∆∞·ªùi" ${
                    songuoi === "11 ng∆∞·ªùi" || songuoi === "11" ? "selected" : ""
                  }>11 ng∆∞·ªùi</option>
                </select>
              </div>
              <div class="form-group">
                <label>K√≠ch th∆∞·ªõc</label>
                <select name="kichthuoc" class="form-control" id="fieldTypeKichthuoc">
                  <option value="">Ch·ªçn k√≠ch th∆∞·ªõc</option>
                  <option value="20m x 40m" ${
                    kichthuoc === "20m x 40m" ? "selected" : ""
                  }>20m x 40m (S√¢n 5)</option>
                  <option value="30m x 50m" ${
                    kichthuoc === "30m x 50m" ? "selected" : ""
                  }>30m x 50m (S√¢n 7)</option>
                  <option value="68m x 105m" ${
                    kichthuoc === "68m x 105m" ? "selected" : ""
                  }>68m x 105m (S√¢n 11)</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>M√¥ t·∫£</label>
              <textarea name="mota" class="form-control" rows="3" id="fieldTypeMota">${mota}</textarea>
            </div>
          </form>
        `;

        // Setup reference type change handler after modal is shown
        setTimeout(() => {
          const refSelect = document.getElementById("fieldTypeReferenceSelect");
          if (refSelect) {
            refSelect.addEventListener("change", function() {
              const typeId = this.value;
              if (!typeId) return;
              const refType = allFieldTypes.find(t => (t.maloaisan || t.id || t.code) === typeId);
              if (refType) {
                const songuoi = refType.songuoi || refType.total_capacity || "";
                const kichthuoc = refType.kichthuoc || refType.size_display || "";
                const mota = refType.mota || refType.description || "";
                
                const songuoiSelect = document.getElementById("fieldTypeSonguoi");
                const kichthuocSelect = document.getElementById("fieldTypeKichthuoc");
                const motaTextarea = document.getElementById("fieldTypeMota");
                
                if (songuoiSelect && songuoi) {
                  songuoiSelect.value = songuoi;
                }
                if (kichthuocSelect && kichthuoc) {
                  kichthuocSelect.value = kichthuoc;
                }
                if (motaTextarea && mota) {
                  motaTextarea.value = mota;
                }
                
                Toast.info("ƒê√£ t·∫£i th√¥ng tin t·ª´ lo·∫°i s√¢n tham kh·∫£o!");
              }
            });
          }
        }, 100);

        formModal.show("Ch·ªânh S·ª≠a Lo·∫°i S√¢n", formHTML, async (data) => {
          try {
            LoadingOverlay.show();
            data.id = type.id || type.maloaisan || type.code;
            await crudManager.saveToXML("FieldTypes.xml", data, "update");
            formModal.close();
            Toast.success("C·∫≠p nh·∫≠t lo·∫°i s√¢n th√†nh c√¥ng!");
            await loadFieldTypes();
          } catch (error) {
            console.error("Error updating field type:", error);
            Toast.error("L·ªói khi c·∫≠p nh·∫≠t lo·∫°i s√¢n: " + error.message);
          } finally {
            LoadingOverlay.hide();
          }
        });
      }

      function deleteFieldType(id) {
        const type = allFieldTypes.find(
          (t) => (t.maloaisan || t.code || t.id) === id
        );
        if (!type) {
          Toast.error("Kh√¥ng t√¨m th·∫•y lo·∫°i s√¢n!");
          return;
        }

        const name = type.tenloaisan || type.name || id;
        ConfirmDialog.show(
          `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a lo·∫°i s√¢n <strong>"${name}"</strong>?<br><small style="color: #666;">M√£: ${
            type.maloaisan || type.code
          }</small>`,
          async () => {
            try {
              LoadingOverlay.show();
              await crudManager.saveToXML(
                "FieldTypes.xml",
                { id: type.id || type.maloaisan || type.code },
                "delete"
              );
              Toast.success("X√≥a lo·∫°i s√¢n th√†nh c√¥ng!");
              await loadFieldTypes();
            } catch (error) {
              console.error("Error deleting field type:", error);
              Toast.error("L·ªói khi x√≥a lo·∫°i s√¢n: " + error.message);
            } finally {
              LoadingOverlay.hide();
            }
          },
          "X√°c Nh·∫≠n X√≥a"
        );
      }

      // Export field types to XML
      function exportFieldTypesXML() {
        crudManager.downloadXML("FieldTypes.xml", "FieldTypes", "fieldType");
        Toast.success("ƒê√£ xu·∫•t file FieldTypes.xml!");
      }
    </script>
  </body>
</html>
