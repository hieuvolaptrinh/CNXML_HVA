<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S√¢n b√≥ng - H·ªá Th·ªëng S√¢n B√≥ng</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/fields.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="js/app.js"></script>
    <script src="js/crud.js"></script>
    <script src="js/components.js"></script>
  </head>
  <body class="fields-page">
    <div id="sidebar"></div>

    <div style="margin-left: 280px; padding: 30px">
      <div
        class="grass-pattern grass-overlay"
        style="padding: 40px 30px; border-radius: 16px; margin-bottom: 30px"
      >
        <div style="position: relative; z-index: 1">
          <h1
            style="
              color: white;
              font-size: 2.5em;
              margin-bottom: 10px;
              text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            "
          >
            <i class="fas fa-map-marked-alt"></i> Qu·∫£n L√Ω S√¢n B√≥ng
          </h1>
          <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.1em">
            Qu·∫£n l√Ω th√¥ng tin v√† tr·∫°ng th√°i c√°c s√¢n b√≥ng
          </p>
        </div>
      </div>

      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        "
      >
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            "
          >
            <i class="fas fa-futbol"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="totalFields">0</div>
            <div class="stat-label">T·ªïng s√¢n</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            "
          >
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="availableFields">0</div>
            <div class="stat-label">S·∫µn s√†ng</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            "
          >
            <i class="fas fa-building"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="totalBranches">0</div>
            <div class="stat-label">Chi nh√°nh</div>
          </div>
        </div>
      </div>

      <div
        class="toolbar-container"
        style="
          background: white;
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 25px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        "
      >
        <div
          style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center"
        >
          <button class="btn btn-primary" onclick="showAddFieldForm()">
            <i class="fas fa-plus"></i> Th√™m S√¢n B√≥ng
          </button>
          <div style="flex: 1; min-width: 250px">
            <input
              type="text"
              id="searchInput"
              placeholder="üîç T√¨m ki·∫øm s√¢n b√≥ng..."
              style="
                width: 100%;
                padding: 10px 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
              "
            />
          </div>
          <select
            id="branchFilter"
            style="
              padding: 10px 15px;
              border: 1px solid #ddd;
              border-radius: 8px;
              min-width: 150px;
            "
          >
            <option value="">T·∫•t c·∫£ chi nh√°nh</option>
          </select>
          <select
            id="statusFilter"
            style="
              padding: 10px 15px;
              border: 1px solid #ddd;
              border-radius: 8px;
              min-width: 150px;
            "
          >
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="Available">S·∫µn s√†ng</option>
            <option value="Maintenance">B·∫£o tr√¨</option>
            <option value="Booked">ƒê√£ ƒë·∫∑t</option>
          </select>
        </div>
      </div>

      <div
        id="fieldsGrid"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
          gap: 25px;
        "
      ></div>
    </div>

    <script>
      let allFields = [];
      let filteredFields = [];
      let allBranches = [];
      let allFieldTypes = [];

      document.addEventListener("DOMContentLoaded", async () => {
        document.getElementById("sidebar").innerHTML = createSidebar("fields");
        requireAuth();
        await loadAllData();
        setupEventListeners();
      });

      async function loadAllData() {
        try {
          LoadingOverlay.show();
          // Load fields, branches, and field types in parallel
          const [fields, branches, fieldTypes] = await Promise.all([
            crudManager.getMergedData("Fields.xml", "field"),
            crudManager.getMergedData("Branches.xml", "branch"),
            crudManager.getMergedData("FieldTypes.xml", "fieldType"),
          ]);

          allFields = fields;
          allBranches = branches;
          allFieldTypes = fieldTypes;

          console.log("Loaded fields:", allFields);
          console.log("Loaded branches:", allBranches);
          console.log("Loaded fieldTypes:", allFieldTypes);

          filteredFields = [...allFields];
          renderFields();
          updateStats();
          populateFilters();
          LoadingOverlay.hide();
        } catch (error) {
          console.error("Error loading data:", error);
          LoadingOverlay.hide();
          Toast.error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu s√¢n b√≥ng");
        }
      }

      async function loadFields() {
        await loadAllData();
      }

      // Generate next field ID
      function getNextFieldId() {
        const maxNum = allFields.reduce((max, f) => {
          const id = f.masan || f.id || "";
          const num = parseInt(id.replace(/\D/g, "") || "0");
          return num > max ? num : max;
        }, 0);
        return `SAN${String(maxNum + 1).padStart(3, "0")}`;
      }

      // Generate branch options
      function getBranchOptions(selectedBranch = "") {
        return allBranches
          .map((b) => {
            const id = b.machinhanh || b.id;
            const name = b.tenchinhanh || b.name || id;
            const selected = id === selectedBranch ? "selected" : "";
            return `<option value="${id}" ${selected}>${name} (${id})</option>`;
          })
          .join("");
      }

      // Generate field type options
      function getFieldTypeOptions(selectedType = "") {
        if (!allFieldTypes || allFieldTypes.length === 0) {
          return '<option value="">-- ƒêang t·∫£i lo·∫°i s√¢n --</option>';
        }
        return allFieldTypes
          .map((ft) => {
            const id = ft.maloaisan || ft.id || ft.code;
            const name = ft.tenloaisan || ft.name || id;
            const songuoi = ft.songuoi || ft.total_capacity || "";
            const displayName = songuoi ? `${name} (${songuoi})` : name;
            const selected = id === selectedType ? "selected" : "";
            return `<option value="${id}" ${selected}>${displayName}</option>`;
          })
          .join("");
      }

      function renderFields() {
        const grid = document.getElementById("fieldsGrid");

        if (filteredFields.length === 0) {
          grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                        <i class="fas fa-futbol" style="font-size: 4em; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #999; font-size: 1.2em;">Kh√¥ng t√¨m th·∫•y s√¢n b√≥ng n√†o</h3>
                    </div>
                `;
          return;
        }

        grid.innerHTML = filteredFields
          .map((field) => {
            const statusColors = {
              Available: { bg: "#4CAF50", text: "S·∫µn s√†ng" },
              Maintenance: { bg: "#FF9800", text: "B·∫£o tr√¨" },
              Booked: { bg: "#f44336", text: "ƒê√£ ƒë·∫∑t" },
            };
            const status = statusColors[field.trangthai] || {
              bg: "#999",
              text: field.trangthai,
            };

            return `
                    <div class="field-card" style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s;">
                        <div style="position: relative;">
                            <img src="${
                              field.hinhanh ||
                              field.image_url ||
                              "https://images.unsplash.com/photo-1529900748604-07564a03e7a6?w=400&h=200&fit=crop"
                            }" 
                                 alt="${field.tensan || field.name || "Field"}" 
                                 style="width: 100%; height: 180px; object-fit: cover;"
                                 onerror="this.src='https://images.unsplash.com/photo-1529900748604-07564a03e7a6?w=400&h=200&fit=crop'">
                            <span style="position: absolute; top: 15px; right: 15px; padding: 6px 12px; border-radius: 20px; font-size: 0.8em; color: white; font-weight: bold; background: ${
                              status.bg
                            };">
                                ${status.text}
                            </span>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 15px;">
                                <h3 style="font-size: 1.4em; color: #333; margin-bottom: 5px;">${
                                  field.tensan || field.name || "N/A"
                                }</h3>
                                <span style="background: #4CAF50; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8em;">
                                    ${field.masan || field.id || "N/A"}
                                </span>
                            </div>
                            <div style="margin: 15px 0; color: #555;">
                                <div style="display: flex; align-items: center; margin: 8px 0;">
                                    <i class="fas fa-building" style="width: 20px; color: #4CAF50;"></i>
                                    <span style="font-size: 0.9em;">${
                                      field.machinhanh ||
                                      field.branch_id ||
                                      "N/A"
                                    }</span>
                                </div>
                                <div style="display: flex; align-items: center; margin: 8px 0;">
                                    <i class="fas fa-layer-group" style="width: 20px; color: #4CAF50;"></i>
                                    <span style="font-size: 0.9em;">${
                                      field.maloaisan ||
                                      field.field_type_id ||
                                      "N/A"
                                    }</span>
                                </div>
                                <div style="display: flex; align-items: center; margin: 8px 0;">
                                    <i class="fas fa-dollar-sign" style="width: 20px; color: #4CAF50;"></i>
                                    <span style="font-size: 0.9em; font-weight: bold;">${formatCurrency(
                                      field.gia || field.price_per_hour || 0
                                    )}/gi·ªù</span>
                                </div>
                            </div>
                            <div style="background: #f1f8f4; padding: 10px; border-radius: 8px; margin: 15px 0;">
                                <p style="font-size: 0.9em; color: #555; margin: 0;">${
                                  field.mota ||
                                  field.description ||
                                  "Kh√¥ng c√≥ m√¥ t·∫£"
                                }</p>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-sm btn-primary" onclick="editField('${
                                  field.masan || field.id
                                }')" style="flex: 1;">
                                    <i class="fas fa-edit"></i> S·ª≠a
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteField('${
                                  field.masan || field.id
                                }')" style="flex: 1;">
                                    <i class="fas fa-trash"></i> X√≥a
                                </button>
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function updateStats() {
        document.getElementById("totalFields").textContent = allFields.length;
        document.getElementById("availableFields").textContent =
          allFields.filter((f) => f.trangthai === "Available").length;

        const branches = [
          ...new Set(allFields.map((f) => f.machinhanh).filter((b) => b)),
        ];
        document.getElementById("totalBranches").textContent = branches.length;
      }

      function populateFilters() {
        const branchFilter = document.getElementById("branchFilter");
        const branches = [
          ...new Set(allFields.map((f) => f.machinhanh).filter((b) => b)),
        ];

        branchFilter.innerHTML =
          '<option value="">T·∫•t c·∫£ chi nh√°nh</option>' +
          branches
            .map((branch) => `<option value="${branch}">${branch}</option>`)
            .join("");
      }

      function setupEventListeners() {
        document
          .getElementById("searchInput")
          .addEventListener("input", debounce(filterFields, 300));
        document
          .getElementById("branchFilter")
          .addEventListener("change", filterFields);
        document
          .getElementById("statusFilter")
          .addEventListener("change", filterFields);
      }

      function filterFields() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const branchFilter = document.getElementById("branchFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;

        filteredFields = allFields.filter((field) => {
          const matchesSearch =
            !searchTerm ||
            (field.tensan || "").toLowerCase().includes(searchTerm) ||
            (field.masan || "").toLowerCase().includes(searchTerm);

          const matchesBranch =
            !branchFilter || field.machinhanh === branchFilter;
          const matchesStatus =
            !statusFilter || field.trangthai === statusFilter;

          return matchesSearch && matchesBranch && matchesStatus;
        });

        renderFields();
      }

      function showAddFieldForm() {
        const nextId = getNextFieldId();
        const formHTML = `
          <form id="fieldForm" style="display: grid; gap: 15px;">
            <div class="form-group">
              <label>M√£ s√¢n <span style="color: red;">*</span></label>
              <input type="text" name="masan" required class="form-control" value="${nextId}">
            </div>
            <div class="form-group">
              <label>T√™n s√¢n <span style="color: red;">*</span></label>
              <input type="text" name="tensan" required class="form-control" placeholder="S√¢n s·ªë 1">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Chi nh√°nh <span style="color: red;">*</span></label>
                <select name="machinhanh" required class="form-control">
                  <option value="">-- Ch·ªçn chi nh√°nh --</option>
                  ${getBranchOptions()}
                </select>
              </div>
              <div class="form-group">
                <label>Lo·∫°i s√¢n <span style="color: red;">*</span></label>
                <select name="maloaisan" required class="form-control">
                  <option value="">-- Ch·ªçn lo·∫°i s√¢n --</option>
                  ${getFieldTypeOptions()}
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Gi√° thu√™ (VNƒê/gi·ªù) <span style="color: red;">*</span></label>
              <input type="number" name="gia" required class="form-control" placeholder="500000" min="0" step="10000">
            </div>
            <div class="form-group">
              <label>M√¥ t·∫£</label>
              <textarea name="mota" class="form-control" rows="3" placeholder="M√¥ t·∫£ v·ªÅ s√¢n b√≥ng..."></textarea>
            </div>
            <div class="form-group">
              <label>H√¨nh ·∫£nh URL</label>
              <input type="url" name="hinhanh" class="form-control" placeholder="https://example.com/image.jpg">
            </div>
            <div class="form-group">
              <label>Tr·∫°ng th√°i</label>
              <select name="trangthai" class="form-control">
                <option value="Available">S·∫µn s√†ng</option>
                <option value="Maintenance">B·∫£o tr√¨</option>
                <option value="Booked">ƒê√£ ƒë·∫∑t</option>
              </select>
            </div>
          </form>
        `;

        formModal.show("Th√™m S√¢n B√≥ng M·ªõi", formHTML, async (data) => {
          try {
            LoadingOverlay.show();
            if (!data.tensan || !data.machinhanh || !data.maloaisan) {
              Toast.error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
              LoadingOverlay.hide();
              return;
            }
            data.id = data.masan;
            await crudManager.saveToXML("Fields.xml", data, "create");
            formModal.close();
            Toast.success("Th√™m s√¢n b√≥ng th√†nh c√¥ng!");
            await loadFields();
          } catch (error) {
            console.error("Error adding field:", error);
            Toast.error("L·ªói khi th√™m s√¢n b√≥ng: " + error.message);
          } finally {
            LoadingOverlay.hide();
          }
        });
      }

      function viewField(id) {
        const field = allFields.find((f) => (f.masan || f.id) === id);
        if (!field) {
          Toast.error("Kh√¥ng t√¨m th·∫•y s√¢n b√≥ng!");
          return;
        }

        const statusColors = {
          Available: { bg: "#4CAF50", text: "S·∫µn s√†ng" },
          Maintenance: { bg: "#FF9800", text: "B·∫£o tr√¨" },
          Booked: { bg: "#f44336", text: "ƒê√£ ƒë·∫∑t" },
        };
        const status = statusColors[field.trangthai] || statusColors.Available;

        const content = `
          <div style="padding: 10px;">
            <div style="text-align: center; margin-bottom: 20px;">
              <img src="${
                field.hinhanh ||
                "https://images.unsplash.com/photo-1529900748604-07564a03e7a6?w=400&h=200&fit=crop"
              }" 
                   style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px;"
                   onerror="this.src='https://images.unsplash.com/photo-1529900748604-07564a03e7a6?w=400&h=200&fit=crop'">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <h4 style="color: #4CAF50; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Th√¥ng tin s√¢n</h4>
                <table style="width: 100%;">
                  <tr><td style="padding: 8px 0; color: #666;">M√£ s√¢n:</td><td style="font-weight: bold;">${
                    field.masan
                  }</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">T√™n s√¢n:</td><td style="font-weight: bold;">${
                    field.tensan
                  }</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">Chi nh√°nh:</td><td>${
                    field.machinhanh
                  }</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">Lo·∫°i s√¢n:</td><td>${
                    field.maloaisan
                  }</td></tr>
                </table>
              </div>
              <div>
                <h4 style="color: #4CAF50; margin-bottom: 15px;"><i class="fas fa-dollar-sign"></i> Gi√° & Tr·∫°ng th√°i</h4>
                <table style="width: 100%;">
                  <tr><td style="padding: 8px 0; color: #666;">Gi√°/gi·ªù:</td><td style="font-weight: bold; color: #4CAF50;">${formatCurrency(
                    field.gia || 0
                  )}</td></tr>
                  <tr><td style="padding: 8px 0; color: #666;">Tr·∫°ng th√°i:</td><td><span style="background: ${
                    status.bg
                  }; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.85em;">${
          status.text
        }</span></td></tr>
                </table>
              </div>
            </div>
            ${
              field.mota
                ? `
              <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <h4 style="color: #666; margin-bottom: 10px;"><i class="fas fa-align-left"></i> M√¥ t·∫£</h4>
                <p style="margin: 0;">${field.mota}</p>
              </div>
            `
                : ""
            }
          </div>
        `;
        detailModal.show(`Chi ti·∫øt s√¢n - ${field.tensan}`, content);
      }

      async function editField(id) {
        const field = allFields.find((f) => (f.masan || f.id) === id);
        if (!field) {
          Toast.error("Kh√¥ng t√¨m th·∫•y s√¢n b√≥ng!");
          return;
        }

        const formHTML = `
          <form id="fieldForm" style="display: grid; gap: 15px;">
            <div class="form-group">
              <label>M√£ s√¢n</label>
              <input type="text" name="masan" class="form-control" value="${
                field.masan || ""
              }" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
              <label>T√™n s√¢n <span style="color: red;">*</span></label>
              <input type="text" name="tensan" required class="form-control" value="${
                field.tensan || ""
              }">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Chi nh√°nh <span style="color: red;">*</span></label>
                <select name="machinhanh" required class="form-control">
                  <option value="">-- Ch·ªçn chi nh√°nh --</option>
                  ${getBranchOptions(field.machinhanh)}
                </select>
              </div>
              <div class="form-group">
                <label>Lo·∫°i s√¢n <span style="color: red;">*</span></label>
                <select name="maloaisan" required class="form-control">
                  <option value="">-- Ch·ªçn lo·∫°i s√¢n --</option>
                  ${getFieldTypeOptions(field.maloaisan)}
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Gi√° thu√™ (VNƒê/gi·ªù) <span style="color: red;">*</span></label>
              <input type="number" name="gia" required class="form-control" value="${
                field.gia || 0
              }" min="0" step="10000">
            </div>
            <div class="form-group">
              <label>M√¥ t·∫£</label>
              <textarea name="mota" class="form-control" rows="3">${
                field.mota || ""
              }</textarea>
            </div>
            <div class="form-group">
              <label>H√¨nh ·∫£nh URL</label>
              <input type="url" name="hinhanh" class="form-control" value="${
                field.hinhanh || ""
              }">
            </div>
            <div class="form-group">
              <label>Tr·∫°ng th√°i</label>
              <select name="trangthai" class="form-control">
                <option value="Available" ${
                  field.trangthai === "Available" ? "selected" : ""
                }>S·∫µn s√†ng</option>
                <option value="Maintenance" ${
                  field.trangthai === "Maintenance" ? "selected" : ""
                }>B·∫£o tr√¨</option>
                <option value="Booked" ${
                  field.trangthai === "Booked" ? "selected" : ""
                }>ƒê√£ ƒë·∫∑t</option>
              </select>
            </div>
          </form>
        `;

        formModal.show("Ch·ªânh S·ª≠a S√¢n B√≥ng", formHTML, async (data) => {
          try {
            LoadingOverlay.show();
            data.id = field.masan || field.id;
            await crudManager.saveToXML("Fields.xml", data, "update");
            formModal.close();
            Toast.success("C·∫≠p nh·∫≠t s√¢n b√≥ng th√†nh c√¥ng!");
            await loadFields();
          } catch (error) {
            console.error("Error updating field:", error);
            Toast.error("L·ªói khi c·∫≠p nh·∫≠t s√¢n b√≥ng: " + error.message);
          } finally {
            LoadingOverlay.hide();
          }
        });
      }

      function deleteField(id) {
        const field = allFields.find((f) => (f.masan || f.id) === id);
        if (!field) {
          Toast.error("Kh√¥ng t√¨m th·∫•y s√¢n b√≥ng!");
          return;
        }

        ConfirmDialog.show(
          `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√¢n <strong>"${field.tensan}"</strong>?<br><small style="color: #666;">M√£ s√¢n: ${field.masan}</small>`,
          async () => {
            try {
              LoadingOverlay.show();
              await crudManager.saveToXML(
                "Fields.xml",
                { id: field.masan || field.id },
                "delete"
              );
              Toast.success("X√≥a s√¢n b√≥ng th√†nh c√¥ng!");
              await loadFields();
            } catch (error) {
              console.error("Error deleting field:", error);
              Toast.error("L·ªói khi x√≥a s√¢n b√≥ng: " + error.message);
            } finally {
              LoadingOverlay.hide();
            }
          },
          "X√°c Nh·∫≠n X√≥a"
        );
      }

      // Export fields to XML
      function exportFieldsXML() {
        crudManager.downloadXML("Fields.xml", "Fields", "field");
        Toast.success("ƒê√£ xu·∫•t file Fields.xml!");
      }
    </script>
  </body>
</html>
