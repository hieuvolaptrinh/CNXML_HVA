<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thi·∫øt b·ªã - H·ªá Th·ªëng S√¢n B√≥ng</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="js/app.js"></script>
    <script src="js/crud.js"></script>
    <script src="js/components.js"></script>
  </head>
  <body>
    <div id="sidebar"></div>

    <div style="margin-left: 280px; padding: 30px">
      <div
        class="grass-pattern grass-overlay"
        style="padding: 40px 30px; border-radius: 16px; margin-bottom: 30px"
      >
        <div style="position: relative; z-index: 1">
          <h1
            style="
              color: white;
              font-size: 2.5em;
              margin-bottom: 10px;
              text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            "
          >
            <i class="fas fa-toolbox"></i> Qu·∫£n L√Ω Thi·∫øt B·ªã
          </h1>
          <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.1em">
            Qu·∫£n l√Ω thi·∫øt b·ªã v√† d·ª•ng c·ª• th·ªÉ thao
          </p>
        </div>
      </div>

      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        "
      >
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            "
          >
            <i class="fas fa-box"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="totalEquipments">0</div>
            <div class="stat-label">T·ªïng thi·∫øt b·ªã</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            "
          >
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="availableEquipments">0</div>
            <div class="stat-label">S·∫µn s√†ng</div>
          </div>
        </div>
        <div class="stat-card">
          <div
            class="stat-icon"
            style="
              background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            "
          >
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="totalValue">0ƒë</div>
            <div class="stat-label">T·ªïng gi√° tr·ªã</div>
          </div>
        </div>
      </div>

      <div
        class="toolbar-container"
        style="
          background: white;
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 25px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        "
      >
        <div
          style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center"
        >
          <button class="btn btn-primary" onclick="showAddEquipmentForm()">
            <i class="fas fa-plus"></i> Th√™m Thi·∫øt B·ªã
          </button>
          <div style="flex: 1; min-width: 250px">
            <input
              type="text"
              id="searchInput"
              placeholder="üîç T√¨m ki·∫øm thi·∫øt b·ªã..."
              style="
                width: 100%;
                padding: 10px 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
              "
            />
          </div>
          <select
            id="statusFilter"
            style="
              padding: 10px 15px;
              border: 1px solid #ddd;
              border-radius: 8px;
              min-width: 150px;
            "
          >
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="Available">S·∫µn s√†ng</option>
            <option value="In Use">ƒêang s·ª≠ d·ª•ng</option>
            <option value="Maintenance">B·∫£o tr√¨</option>
            <option value="Damaged">H·ªèng</option>
          </select>
        </div>
      </div>

      <div
        id="equipmentsGrid"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
          gap: 25px;
        "
      ></div>
    </div>

    <script>
      let allEquipments = [];
      let filteredEquipments = [];

      document.addEventListener("DOMContentLoaded", async () => {
        document.getElementById("sidebar").innerHTML =
          createSidebar("equipments");
        requireAuth();
        await loadEquipments();
        setupEventListeners();
      });

      async function loadEquipments() {
        try {
          LoadingOverlay.show();
          allEquipments = await crudManager.getMergedData(
            "Equipments.xml",
            "equipment"
          );
          filteredEquipments = [...allEquipments];
          renderEquipments();
          updateStats();
          LoadingOverlay.hide();
        } catch (error) {
          console.error("Error loading equipments:", error);
          LoadingOverlay.hide();
          Toast.error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu thi·∫øt b·ªã");
        }
      }

      function renderEquipments() {
        const grid = document.getElementById("equipmentsGrid");

        if (filteredEquipments.length === 0) {
          grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                        <i class="fas fa-toolbox" style="font-size: 4em; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #999; font-size: 1.2em;">Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã n√†o</h3>
                    </div>
                `;
          return;
        }

        grid.innerHTML = filteredEquipments
          .map((equipment) => {
            const statusColors = {
              Available: { bg: "#4CAF50", text: "S·∫µn s√†ng" },
              "In Use": { bg: "#2196F3", text: "ƒêang d√πng" },
              Maintenance: { bg: "#FF9800", text: "B·∫£o tr√¨" },
              Damaged: { bg: "#f44336", text: "H·ªèng" },
            };
            const status = statusColors[equipment.trangthai] || {
              bg: "#999",
              text: equipment.trangthai,
            };

            return `
                    <div class="equipment-card" style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; text-align: center; color: white; position: relative;">
                            <i class="fas fa-tools" style="font-size: 3em; margin-bottom: 10px;"></i>
                            <span style="position: absolute; top: 15px; right: 15px; background: ${
                              status.bg
                            }; padding: 6px 12px; border-radius: 20px; font-size: 0.8em;">
                                ${status.text}
                            </span>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 15px;">
                                <h3 style="font-size: 1.4em; color: #333; margin-bottom: 5px;">${
                                  equipment.tendungcu || "N/A"
                                }</h3>
                                <span style="background: #4CAF50; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8em;">
                                    ${equipment.madungcu || "N/A"}
                                </span>
                            </div>
                            <div style="margin: 15px 0; color: #555;">
                                <div style="display: flex; align-items: center; margin: 8px 0;">
                                    <i class="fas fa-hashtag" style="width: 20px; color: #667eea;"></i>
                                    <span style="font-size: 0.9em;">S·ªë l∆∞·ª£ng: <strong>${
                                      equipment.soluong || 0
                                    }</strong></span>
                                </div>
                                <div style="display: flex; align-items: center; margin: 8px 0;">
                                    <i class="fas fa-dollar-sign" style="width: 20px; color: #667eea;"></i>
                                    <span style="font-size: 0.9em;">Gi√°: <strong>${formatCurrency(
                                      equipment.gia || 0
                                    )}</strong></span>
                                </div>
                                <div style="display: flex; align-items: center; margin: 8px 0;">
                                    <i class="fas fa-building" style="width: 20px; color: #667eea;"></i>
                                    <span style="font-size: 0.9em;">${
                                      equipment.machinhanh || "N/A"
                                    }</span>
                                </div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 15px 0;">
                                <p style="font-size: 0.9em; color: #555; margin: 0;">${
                                  equipment.mota || "Kh√¥ng c√≥ m√¥ t·∫£"
                                }</p>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-sm btn-primary" onclick="editEquipment('${
                                  equipment.id || equipment.madungcu
                                }')" style="flex: 1;">
                                    <i class="fas fa-edit"></i> S·ª≠a
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteEquipment('${
                                  equipment.id || equipment.madungcu
                                }')" style="flex: 1;">
                                    <i class="fas fa-trash"></i> X√≥a
                                </button>
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function updateStats() {
        document.getElementById("totalEquipments").textContent =
          allEquipments.length;
        document.getElementById("availableEquipments").textContent =
          allEquipments.filter((e) => e.trangthai === "Available").length;

        const totalValue = allEquipments.reduce(
          (sum, e) =>
            sum + (parseFloat(e.gia) || 0) * (parseInt(e.soluong) || 0),
          0
        );
        document.getElementById("totalValue").textContent =
          formatCurrency(totalValue);
      }

      function setupEventListeners() {
        document
          .getElementById("searchInput")
          .addEventListener("input", debounce(filterEquipments, 300));
        document
          .getElementById("statusFilter")
          .addEventListener("change", filterEquipments);
      }

      function filterEquipments() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter").value;

        filteredEquipments = allEquipments.filter((equipment) => {
          const matchesSearch =
            !searchTerm ||
            (equipment.tendungcu || "").toLowerCase().includes(searchTerm) ||
            (equipment.madungcu || "").toLowerCase().includes(searchTerm);

          const matchesStatus =
            !statusFilter || equipment.trangthai === statusFilter;

          return matchesSearch && matchesStatus;
        });

        renderEquipments();
      }

      function showAddEquipmentForm() {
        const formHTML = `
                <form id="equipmentForm" style="display: grid; gap: 15px;">
                    <div class="form-group">
                        <label>M√£ d·ª•ng c·ª• <span style="color: red;">*</span></label>
                        <input type="text" name="madungcu" required class="form-control" placeholder="DC-001">
                    </div>
                    <div class="form-group">
                        <label>T√™n d·ª•ng c·ª• <span style="color: red;">*</span></label>
                        <input type="text" name="tendungcu" required class="form-control" placeholder="B√≥ng ƒë√°">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>S·ªë l∆∞·ª£ng <span style="color: red;">*</span></label>
                            <input type="number" name="soluong" required class="form-control" placeholder="10" min="0">
                        </div>
                        <div class="form-group">
                            <label>Gi√° <span style="color: red;">*</span></label>
                            <input type="number" name="gia" required class="form-control" placeholder="200000" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>M√£ chi nh√°nh</label>
                        <input type="text" name="machinhanh" class="form-control" placeholder="CN-HN">
                    </div>
                    <div class="form-group">
                        <label>M√¥ t·∫£</label>
                        <textarea name="mota" class="form-control" rows="3" placeholder="M√¥ t·∫£ thi·∫øt b·ªã..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tr·∫°ng th√°i</label>
                        <select name="trangthai" class="form-control">
                            <option value="Available">S·∫µn s√†ng</option>
                            <option value="In Use">ƒêang s·ª≠ d·ª•ng</option>
                            <option value="Maintenance">B·∫£o tr√¨</option>
                            <option value="Damaged">H·ªèng</option>
                        </select>
                    </div>
                </form>
            `;

        formModal.show("Th√™m Thi·∫øt B·ªã M·ªõi", formHTML, async (data) => {
          try {
            data.id = generateId("EQ");
            await crudManager.saveToXML("DungCu.xml", data, "create");
            formModal.close();
            Toast.success("Th√™m thi·∫øt b·ªã th√†nh c√¥ng!");
            await loadEquipments();
          } catch (error) {
            Toast.error("L·ªói khi th√™m thi·∫øt b·ªã!");
          }
        });
      }

      async function editEquipment(id) {
        const equipment = allEquipments.find(
          (e) => (e.id || e.madungcu) === id
        );
        if (!equipment) return;

        const formHTML = `
                <form id="equipmentForm" style="display: grid; gap: 15px;">
                    <div class="form-group">
                        <label>M√£ d·ª•ng c·ª• <span style="color: red;">*</span></label>
                        <input type="text" name="madungcu" required class="form-control" value="${
                          equipment.madungcu || ""
                        }" readonly>
                    </div>
                    <div class="form-group">
                        <label>T√™n d·ª•ng c·ª• <span style="color: red;">*</span></label>
                        <input type="text" name="tendungcu" required class="form-control" value="${
                          equipment.tendungcu || ""
                        }">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>S·ªë l∆∞·ª£ng <span style="color: red;">*</span></label>
                            <input type="number" name="soluong" required class="form-control" value="${
                              equipment.soluong || 0
                            }" min="0">
                        </div>
                        <div class="form-group">
                            <label>Gi√° <span style="color: red;">*</span></label>
                            <input type="number" name="gia" required class="form-control" value="${
                              equipment.gia || 0
                            }" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>M√£ chi nh√°nh</label>
                        <input type="text" name="machinhanh" class="form-control" value="${
                          equipment.machinhanh || ""
                        }">
                    </div>
                    <div class="form-group">
                        <label>M√¥ t·∫£</label>
                        <textarea name="mota" class="form-control" rows="3">${
                          equipment.mota || ""
                        }</textarea>
                    </div>
                    <div class="form-group">
                        <label>Tr·∫°ng th√°i</label>
                        <select name="trangthai" class="form-control">
                            <option value="Available" ${
                              equipment.trangthai === "Available"
                                ? "selected"
                                : ""
                            }>S·∫µn s√†ng</option>
                            <option value="In Use" ${
                              equipment.trangthai === "In Use" ? "selected" : ""
                            }>ƒêang s·ª≠ d·ª•ng</option>
                            <option value="Maintenance" ${
                              equipment.trangthai === "Maintenance"
                                ? "selected"
                                : ""
                            }>B·∫£o tr√¨</option>
                            <option value="Damaged" ${
                              equipment.trangthai === "Damaged"
                                ? "selected"
                                : ""
                            }>H·ªèng</option>
                        </select>
                    </div>
                </form>
            `;

        formModal.show("Ch·ªânh S·ª≠a Thi·∫øt B·ªã", formHTML, async (data) => {
          try {
            data.id = equipment.id || equipment.madungcu;
            await crudManager.saveToXML("DungCu.xml", data, "update");
            formModal.close();
            Toast.success("C·∫≠p nh·∫≠t thi·∫øt b·ªã th√†nh c√¥ng!");
            await loadEquipments();
          } catch (error) {
            Toast.error("L·ªói khi c·∫≠p nh·∫≠t thi·∫øt b·ªã!");
          }
        });
      }

      function deleteEquipment(id) {
        const equipment = allEquipments.find(
          (e) => (e.id || e.madungcu) === id
        );
        if (!equipment) return;

        ConfirmDialog.show(
          `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a thi·∫øt b·ªã "${equipment.tendungcu}"?`,
          async () => {
            try {
              await crudManager.saveToXML(
                "DungCu.xml",
                { id: equipment.id || equipment.madungcu },
                "delete"
              );
              Toast.success("X√≥a thi·∫øt b·ªã th√†nh c√¥ng!");
              await loadEquipments();
            } catch (error) {
              Toast.error("L·ªói khi x√≥a thi·∫øt b·ªã!");
            }
          },
          "X√°c Nh·∫≠n X√≥a"
        );
      }
    </script>
  </body>
</html>
